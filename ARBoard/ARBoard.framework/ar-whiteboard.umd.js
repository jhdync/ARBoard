/*!
  * ar-whiteboard v1.2.1-fix.0
  * (c) 2023 anyRTC WhiteBoard SDK
  * @license MIT
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).self=t.self||{})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},e(t,i)};function i(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}var o=function(){return o=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},o.apply(this,arguments)};function r(t,e,i,o){return new(i||(i=Promise))((function(r,n){function s(t){try{h(o.next(t))}catch(t){n(t)}}function a(t){try{h(o.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}h((o=o.apply(t,e||[])).next())}))}function n(t,e){var i,o,r,n,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(r=2&n[0]?o.return:n[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,n[1])).done)return r;switch(o=0,r&&(n=[2&n[0],r.value]),n[0]){case 0:case 1:r=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,o=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==n[0]&&2!==n[0])){s=0;continue}if(3===n[0]&&(!r||n[1]>r[0]&&n[1]<r[3])){s.label=n[1];break}if(6===n[0]&&s.label<r[1]){s.label=r[1],r=n;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(n);break}r[2]&&s.ops.pop(),s.trys.pop();continue}n=e.call(t,s)}catch(t){n=[6,t],o=0}finally{i=r=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}}function s(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],o=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var o,r,n=i.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(o=n.next()).done;)s.push(o.value)}catch(t){r={error:t}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(r)throw r.error}}return s}function h(t,e,i){if(i||2===arguments.length)for(var o,r=0,n=e.length;r<n;r++)!o&&r in e||(o||(o=Array.prototype.slice.call(e,0,r)),o[r]=e[r]);return t.concat(o||Array.prototype.slice.call(e))}var c,l,d,p={SDK_VERSION:"1.2.1-fix.0",GATEWAY_ADDRESS:"https://wbgw.agrtc.cn",GATEWAY_ADDRESS1:"https://wbgw.agrtc.cn",GATEWAY_ADDRESS_SSL:!0,GATEWAY_CONNECT_TIMEOUT:2e3,REPORT_DOMAIN:"",REPORT_BACKUP_DOMAIN:"",LOADING_ICON:"data:image/svg+xml,%3c%3fxml version='1.0' encoding='UTF-8'%3f%3e%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' style='margin: auto%3b display: block%3b' width='140px' height='140px' viewBox='0 0 100 100' preserveAspectRatio='xMidYMid'%3e %3cdefs%3e %3cfilter id='filter' x='-100%25' y='-100%25' width='300%25' height='300%25' color-interpolation-filters='sRGB'%3e %3cfeGaussianBlur in='SourceGraphic' stdDeviation='2.4000000000000004'%3e%3c/feGaussianBlur%3e %3cfeComponentTransfer result='cutoff'%3e %3cfeFuncA type='table' tableValues='0 0 0 0 0 0 1 1 1 1 1'%3e%3c/feFuncA%3e %3c/feComponentTransfer%3e %3c/filter%3e %3c/defs%3e %3cg filter='url(%23filter)'%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23220b09'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='4s' repeatCount='indefinite' begin='-0.25s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='4s' repeatCount='indefinite' begin='0s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23d34c31'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='2s' repeatCount='indefinite' begin='-0.20833333333333334s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='2s' repeatCount='indefinite' begin='-0.041666666666666664s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23e88432'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='1.3333333333333333s' repeatCount='indefinite' begin='-0.16666666666666666s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='1.3333333333333333s' repeatCount='indefinite' begin='-0.08333333333333333s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23ff312d'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='1s' repeatCount='indefinite' begin='-0.125s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='1s' repeatCount='indefinite' begin='-0.125s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23f5c037'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='0.8s' repeatCount='indefinite' begin='-0.08333333333333333s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='0.8s' repeatCount='indefinite' begin='-0.16666666666666666s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23e89788'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='0.6666666666666666s' repeatCount='indefinite' begin='-0.041666666666666664s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='0.6666666666666666s' repeatCount='indefinite' begin='-0.20833333333333334s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3c/g%3e%3c/svg%3e",BOARD_IMAGE_RESOURCE_TIMEOUT:3e4,BOARD_BACKGROUND_COLOR:"#FFFFFF",BOARD_SELECT_STYLE:{lineDash:[5,5],lineWidth:1,strokeStyle:"#ababab"},SHAPE_SELECT_STYLE:{lineDash:[8,8],strokeStyle:"#ababab",lineWidth:1},TEXT_INPUT_ELEMENT_OPTIONS:{kind:"textarea",props:{"has-origin-text":"0",spellCheck:!1},style:{":focus-border":"1px solid red","z-index":"9",position:"absolute",display:"inline-block","backface-visibility":"hidden",margin:"0px",padding:"0px",outline:"none",resize:"none",background:"transparent",overflow:"hidden","white-space":"pre-wrap","word-break":"break-all","font-family":"customFontFamily , sans-serif, serif, monospace","font-style":"normal","font-weight":"normal",top:"0px",left:"0px","min-width":"12px","min-height":"12px",width:"12px",height:"12px",border:"1px solid transparent","box-sizing":"content-box",color:"#333333","font-size":"12px","line-height":"12px"}},CONTROL_DIR_STYLE:{position:"absolute",width:"8px",height:"8px",background:"red","background-clip":"padding-box",border:"2px solid transparent","box-sizing":"content-box"}};!function(t){t[t.INVALID_PARAMS=1e3]="INVALID_PARAMS",t[t.INVALID_OPERATION=1001]="INVALID_OPERATION"}(c||(c={})),t.EBoardErrorCode=void 0,(l=t.EBoardErrorCode||(t.EBoardErrorCode={}))[l.INIT_ERROR=2e3]="INIT_ERROR",l[l.AUTH_FAILED=2001]="AUTH_FAILED",l[l.AUTH_TIMEOUT=2002]="AUTH_TIMEOUT",l[l.HISTORY_SYNC_FAILED=2003]="HISTORY_SYNC_FAILED",l[l.GET_SNAP_SHORT_FAILED=2100]="GET_SNAP_SHORT_FAILED",function(t){t[t.INVALID_IMAGE_ASSETS=3e3]="INVALID_IMAGE_ASSETS",t[t.TIME_OUT=3001]="TIME_OUT"}(d||(d={}));var u,_,f,v,E,g,y="NETWORK_TIMEOUT",S="NETWORK_RESPONSE_ERROR",m="NETWORK_ERROR",T="MISSING_PARAMETER",A="DEVELOPER_INVALID",b="UID_BANNED",I="IP_BANNED",C="CHANNEL_BANNED",D="APPID_INVALID",w="SERVER_NOT_OPEN",B="TOKEN_EXPIRED",R="TOKEN_INVALID",O="CAN_NOT_GET_GATEWAY_SERVER",L="GATEWAY_SERVER_ERROR";t.EBoardTextStyle=void 0,(u=t.EBoardTextStyle||(t.EBoardTextStyle={}))[u.NORMAL=0]="NORMAL",u[u.BOLD=1]="BOLD",u[u.ITALIC=2]="ITALIC",u[u.BOLD_ITALIC=3]="BOLD_ITALIC",function(t){t.ARROW="Arrow",t.CIRCLE="Circle",t.LASER_POINTER="LaserPointer",t.ELLIPSE="Ellipse",t.RECT="Rect",t.LINE="Line",t.FREE_DRAW="FreeDraw",t.TEXT="Text"}(_||(_={})),function(t){t[t.CONNECT=2e5]="CONNECT",t[t.INIT=3e5]="INIT",t[t.CHAN_DATA=300001]="CHAN_DATA",t[t.ADD_FILE=300002]="ADD_FILE",t[t.FILE_LIST=300004]="FILE_LIST",t[t.CUR_BOARD_DATA=300006]="CUR_BOARD_DATA",t[t.CACHE_BOARD_DATA=300007]="CACHE_BOARD_DATA",t[t.RE_UPLOAD=300008]="RE_UPLOAD",t[t.ADD_BOARD=310003]="ADD_BOARD",t[t.SWITCH_BOARD=310004]="SWITCH_BOARD",t[t.DELETE_BOARD=310005]="DELETE_BOARD",t[t.SCALE_BOARD=310006]="SCALE_BOARD",t[t.RATIO_BOARD=310007]="RATIO_BOARD",t[t.RESET_BOARD=310008]="RESET_BOARD",t[t.CLEAR_BOARD=310009]="CLEAR_BOARD",t[t.UPDATE_BACKGROUND=310010]="UPDATE_BACKGROUND",t[t.UPDATE_BACKGROUND_IMAGE=310011]="UPDATE_BACKGROUND_IMAGE",t[t.UPDATE_BACKGROUND_H5=310012]="UPDATE_BACKGROUND_H5",t[t.ADD_SHAPE=32e4]="ADD_SHAPE",t[t.MOVE_SHAPE=320001]="MOVE_SHAPE",t[t.DELETE_SHAPE=320002]="DELETE_SHAPE",t[t.PROCESS_SHAPE=320003]="PROCESS_SHAPE",t[t.INVALID_PARAMS=4e5]="INVALID_PARAMS",t[t.INTERNAL_ERROR=5e5]="INTERNAL_ERROR",t[t.KEEP_A_LIVE=6e5]="KEEP_A_LIVE"}(f||(f={})),function(t){t.ERROR="board-error",t.WARNING="board-warning",t.CONNECTION_STATE_CHANGE="connection-state-change",t.DATA_SYNC_COMPLETED="data-sync-completed",t.ADD_BOARD="add-board",t.DELETE_BOARD="delete-board",t.GOTO_BOARD="goto-board",t.CLEAR_BOARD="clear-board",t.RESET_BOARD="reset-board",t.SCALE_BOARD="board-scale-change",t.RATIO_BOARD="board-ratio-change",t.CAN_UNDO_STATUS_CHANGE="board-can-undo-status",t.CAN_REDO_STATUS_CHANGE="board-can-redo-status",t.BOARD_BACKGROUND_COLOR_CHANGE="board-background-color-change",t.IMAGE_STATUS_CHANGED="board-image-status-changed"}(v||(v={})),t.EBoardToolType=void 0,(E=t.EBoardToolType||(t.EBoardToolType={}))[E.NONE=0]="NONE",E[E.SELECT=1]="SELECT",E[E.FREE_DRAW=2]="FREE_DRAW",E[E.ERASER=3]="ERASER",E[E.LASER_POINTER=4]="LASER_POINTER",E[E.LINE=5]="LINE",E[E.ARROW=6]="ARROW",E[E.RECT=7]="RECT",E[E.ELLIPSE=8]="ELLIPSE",E[E.TEXT=9]="TEXT",function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SELECTED=1]="SELECTED",t[t.FOCUSED=2]="FOCUSED"}(g||(g={}));var x,N=function(){function t(t,e,i,o,r){void 0===o&&(o=[0,0]),this.id="",this.rectWithStrokePadding=10,this._props={},this._position=[0,0],this._rect={x:0,y:0,width:0,height:0},this._rectWithStroke={x:0,y:0,width:0,height:0},this.style={lineWidth:1,opacity:1,lineDash:[],fillStyle:"",strokeStyle:"#000000"},this.selectState=g.DEFAULT,this.group=0,this.id=t,this.type=e,r&&(this.style=r),this.props=i,this.position=o}return Object.defineProperty(t.prototype,"props",{get:function(){return this._props},set:function(t){this._props=t,this._rect=this._calculateShapeRectBounding(),this._rectWithStroke=this._calculateShapeRectWithStrokeBounding()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this._rect=this._calculateShapeRectBounding(),this._rectWithStroke=this._calculateShapeRectWithStrokeBounding()},enumerable:!1,configurable:!0}),t.prototype.getBoundingRect=function(){return this._rectWithStroke},t.prototype.rectContain=function(t,e){var i=this._rectWithStroke,o=i.x,r=i.y,n=i.width,s=i.height;return t>=o&&t<=o+n&&e>=r&&e<=r+s},t.prototype.isPointInPath=function(t,e){return!1},t.prototype.buildPath=function(t,e){var i=o(o({},this.style),null==e?void 0:e.style),r=i.strokeStyle,n=i.lineWidth,s=i.lineDash,a=i.fillStyle;a&&(t.fillStyle=a),r&&(t.strokeStyle=r),n&&(t.lineWidth=n),s&&t.setLineDash(s)},t.prototype.buildElement=function(t){},t.prototype.attr=function(t,e){"props"===t?this.props=o(o({},this.props),e):"position"===t?this.position=h([],a(e)):"style"===t&&(this.style=o(o({},this.style),e))},t.prototype._calculateShapeRectBounding=function(){return{x:0,y:0,width:0,height:0}},t.prototype._calculateShapeRectWithStrokeBounding=function(){return{x:0,y:0,width:0,height:0}},t}(),P=function(t){function e(e,i){return t.call(this,e,_.ARROW,i.props||{points:[]},i.position||[0,0],i.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this}return i(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props.points,e=this.position;if(4===(null==t?void 0:t.length)){var i=this.style.lineWidth,o=i/2,r=0,n=0,s=0,a=0;t.forEach((function(t,i){0===i?(r=s=t[0]+e[0],n=a=t[1]+e[1]):(r=t[0]+e[0]<r?t[0]+e[0]:r,n=t[1]+e[1]<n?t[1]+e[1]:n,s=t[0]+e[0]>s?t[0]+e[0]:s,a=t[1]+e[1]>a?t[1]+e[1]:a)}));var h=Math.floor(Math.abs(s-r)),c=Math.floor(Math.abs(a-n));return{x:r-o,y:n-o,width:h+i,height:c+i}}return{x:0,y:0,width:0,height:0}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props.points,e=this.position;if(4===(null==t?void 0:t.length)){var i=this.style.lineWidth,o=i/2,r=0,n=0,s=0,a=0;t.forEach((function(t,i){0===i?(r=s=t[0]+e[0],n=a=t[1]+e[1]):(r=t[0]+e[0]<r?t[0]+e[0]:r,n=t[1]+e[1]<n?t[1]+e[1]:n,s=t[0]+e[0]>s?t[0]+e[0]:s,a=t[1]+e[1]>a?t[1]+e[1]:a)}));var h=Math.floor(Math.abs(s-r)),c=Math.floor(Math.abs(a-n));return{x:r-this.rectWithStrokePadding/2-o,y:n-this.rectWithStrokePadding/2-o,width:h+this.rectWithStrokePadding+i,height:c+this.rectWithStrokePadding+i}}return{x:0,y:0,width:0,height:0}},e.prototype.isPointInPath=function(t,e){var i=this._props.points,o=this.position;if(4===(null==i?void 0:i.length)){var r=this.style.lineWidth/2,n=0,s=0,a=0,h=0;return i.forEach((function(t,e){0===e?(n=a=t[0]+o[0],s=h=t[1]+o[1]):(n=(t[0]+o[0]<n?t[0]+o[0]:n)-r,s=(t[1]+o[1]<s?t[1]+o[1]:s)-r,a=(t[0]+o[0]>a?t[0]+o[0]:a)+r,h=(t[1]+o[1]>h?t[1]+o[1]:h)+r)})),t>=n&&t<=a&&e>=s&&e<=h}return!1},e.prototype.buildPath=function(e,i){e.save(),t.prototype.buildPath.call(this,e,i);var r=o(o({},this.props),null==i?void 0:i.props),n=(null==i?void 0:i.position)||this.position;if(r&&r.points&&r.points.length>=4){var s=r.points;e.beginPath(),e.moveTo(s[0][0]+n[0],s[0][1]+n[1]),e.lineTo(s[1][0]+n[0],s[1][1]+n[1]),e.moveTo(s[2][0]+n[0],s[2][1]+n[1]),e.lineTo(s[1][0]+n[0],s[1][1]+n[1]),e.lineTo(s[3][0]+n[0],s[3][1]+n[1]),e.stroke()}e.restore()},e}(N),M=function(t){function e(e,i){return t.call(this,e,_.CIRCLE,i.props||{x1:0,y1:0,x2:0,y2:0},i.position||[0,0],i.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this}return i(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x1,i=t.x2,o=t.y1,r=t.y2,n=this.style.lineWidth,s=n/2;return{x:(e<i?e:i)-s,y:(o<r?o:r)-s,width:Math.abs(e-i)+n,height:Math.abs(o-r)+n}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x1,i=t.x2,o=t.y1,r=t.y2,n=this.style.lineWidth,s=n/2,a=(o<r?o:r)-s;return{x:(e<i?e:i)-s-this.rectWithStrokePadding/2,y:a-this.rectWithStrokePadding/2,width:Math.abs(e-i)+this.rectWithStrokePadding+n,height:Math.abs(o-r)+this.rectWithStrokePadding+n}},e.prototype.isPointInPath=function(t,e){var i=this._props,o=i.x1,r=i.x2,n=i.y1,s=i.y2,a=this.style.lineWidth/2;return t>=(o<r?o:r)-a&&t<=(o<r?r:o)+a&&e>=(n<s?n:s)-a&&e<=(n<s?s:n)+a},e.prototype.buildPath=function(e,i){t.prototype.buildPath.call(this,e,i);var o=i.props,r=i.style;if(r&&r.fillStyle||this.style&&this.style.fillStyle,o){var n=o.x1,s=o.x2,a=o.y1,h=o.y2,c=0,l=0,d=0,p=0;n<s?(c=n,l=a,d=s,p=h):(c=s,l=h,d=n,p=a);var u=Math.abs(d-c),_=Math.abs(p-l),f=u<_?_/2:u/2,v=c+f,E=l+f;e.beginPath(),e.arc(v,E,f,0,360),e.stroke()}},e}(N),k=function(t){function e(e,i){return t.call(this,e,_.ELLIPSE,i.props||{cx:0,cy:0,xr:0,yr:0},i.position||[0,0],i.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this}return i(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.cx,i=t.cy,o=t.xr,r=t.yr,n=this.position,s=this.style.lineWidth/2;return{x:Math.floor(e-o)+n[0]-s,y:Math.floor(i-r)+n[1]-s,width:2*o+s,height:2*r+s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.cx,i=t.cy,o=t.xr,r=t.yr,n=this.position,s=this.style.lineWidth,a=s/2,h=Math.floor(e-o)+n[0]-a,c=Math.floor(i-r)+n[1]-a;return{x:h-this.rectWithStrokePadding/2,y:c-this.rectWithStrokePadding/2,width:2*o+this.rectWithStrokePadding+s,height:2*r+this.rectWithStrokePadding+s}},e.prototype.isPointInPath=function(t,e){var i=this._props,o=i.cx,r=i.cy,n=i.xr,s=i.yr,a=this.position,h=this.style.lineWidth/2,c=Math.floor(o-n)+a[0]-h,l=Math.floor(r-s)+a[1]-h,d=Math.floor(o+n)+a[0]+h,p=Math.floor(r+s)+a[1]+h;return t>=c&&t<=d&&e>=l&&e<=p},e.prototype.buildPath=function(e,i){e.save(),t.prototype.buildPath.call(this,e,i);var r=o(o({},this.props),null==i?void 0:i.props),n=(null==i?void 0:i.position)||this.position;if(r){var s=r.cx,a=r.cy,h=r.xr,c=r.yr;e.beginPath(),e.ellipse(s+n[0],a+n[1],h,c,0,0,360),e.stroke()}e.restore()},e}(N),W=function(t){function e(e,i){return t.call(this,e,_.FREE_DRAW,i.props||{points:[]},i.position||[0,0],i.style||{lineWidth:1,strokeStyle:"#000000"})||this}return i(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this.props.points,e=this.position;if(t&&t.length>1){var i=0,o=0,r=0,n=0;t.forEach((function(t,s){0===s?(i=r=t[0]+e[0],o=n=t[1]+e[1]):(i=t[0]+e[0]<i?t[0]+e[0]:i,o=t[1]+e[1]<o?t[1]+e[1]:o,r=t[0]+e[0]>r?t[0]+e[0]:r,n=t[1]+e[1]>n?t[1]+e[1]:n)}));var s=this.style.lineWidth,a=s/2,h=Math.floor(Math.abs(r-i))+s,c=Math.floor(Math.abs(n-o))+s;return{x:i-a,y:o-a,width:h,height:c}}return{x:0,y:0,width:0,height:0}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this.props.points,e=this.position;if(t&&t.length>1){var i=0,o=0,r=0,n=0;t.forEach((function(t,s){0===s?(i=r=t[0]+e[0],o=n=t[1]+e[1]):(i=t[0]+e[0]<i?t[0]+e[0]:i,o=t[1]+e[1]<o?t[1]+e[1]:o,r=t[0]+e[0]>r?t[0]+e[0]:r,n=t[1]+e[1]>n?t[1]+e[1]:n)}));var s=this.style.lineWidth,a=s/2,h=Math.floor(Math.abs(r-i))+s,c=Math.floor(Math.abs(n-o))+s;return{x:i-a-this.rectWithStrokePadding/2,y:o-a-this.rectWithStrokePadding/2,width:h+this.rectWithStrokePadding,height:c+this.rectWithStrokePadding}}return{x:0,y:0,width:0,height:0}},e.prototype.isPointInPath=function(t,e){var i=this.props.points,o=this.position;if(i&&i.length>1){var r=this.style.lineWidth/2,n=0,s=0,a=0,h=0;return i.forEach((function(t,e){0===e?(n=a=t[0]+o[0],s=h=t[1]+o[1]):(n=(t[0]+o[0]<n?t[0]+o[0]:n)-r,s=(t[1]+o[1]<s?t[1]+o[1]:s)-r,a=(t[0]+o[0]>a?t[0]+o[0]:a)+r,h=(t[1]+o[1]>h?t[1]+o[1]:h)+r)})),t>=n&&t<=a&&e>=s&&e<=h}return!1},e.prototype.buildPath=function(e,i){e.save(),t.prototype.buildPath.call(this,e,i);var r=o(o({},this.props),null==i?void 0:i.props),n=(null==i?void 0:i.position)||this.position;if(r){var s=r.points,a=n[0],h=n[1];if(!s)return;if(s.length>2){e.lineCap="round",e.lineJoin="round",e.beginPath();for(var c=0;c<s.length-1;c++)if(0===c)e.moveTo(s[0][0]+a,s[0][1]+h);else if(c===s.length-2)e.lineTo(s[c-1][0]+a,s[c-1][1]+h),e.stroke();else{if(c===s.length-1)return;var l=s[c+1],d=(l[0]+s[c+2][0])/2+a,p=(l[1]+s[c+2][1])/2+h;e.quadraticCurveTo(l[0]+a,l[1]+h,d,p)}}}e.restore()},e}(N),U=function(t,e){void 0===e&&(e={});var i=t.kind,r=t.key,n=t.props,s=t.style,a=t.children,h=document.createElement(i);return r&&(e[r]=h),n&&Object.keys(n).forEach((function(t){h.setAttribute(t,n[t])})),s&&Object.keys(s).forEach((function(t){h.style.setProperty(t,s[t])})),a&&a.forEach((function(t){var i=U(t,e);t.key&&(e[t.key]=i.el),h.append(i.el)})),o(o({},e),{el:h})},G=function(t){function e(e,i){var o=t.call(this,e,_.LASER_POINTER,i.props||{cx:0,cy:0,r:0},i.position||[0,0],i.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this;o.touchId=0;var r=U({kind:"div",props:{"data-uid":e,class:"board-laser_item"},style:{position:"absolute",left:"0",top:"0",width:"32px",height:"32px","z-index":"40","will-change":"transform","pointer-events":"none",transform:"translate("+(o.props.cx+o.position[0]||0)+"px, "+(o.props.cy+o.position[1]||0)+"px) scale(1.0)"},children:[{kind:"img",props:{src:"data:image/svg+xml,%3c%3fxml version='1.0' encoding='UTF-8'%3f%3e%3csvg width='32px' height='32px' viewBox='0 0 32 32' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e %3ctitle%3elaser-pointer%3c/title%3e %3cdefs%3e %3cradialGradient cx='50%25' cy='50%25' fx='50%25' fy='50%25' r='50%25' id='radialGradient-1'%3e %3cstop stop-color='%23FF001C' offset='0%25'%3e%3c/stop%3e %3cstop stop-color='%23FF001C' stop-opacity='0' offset='100%25'%3e%3c/stop%3e %3c/radialGradient%3e %3c/defs%3e %3cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'%3e %3cg transform='translate(-2.000000%2c -2.000000)'%3e %3ccircle fill='url(%23radialGradient-1)' cx='18' cy='18' r='12'%3e%3c/circle%3e %3ccircle stroke='white' fill='%23FF001C' cx='18' cy='18' r='2.5'%3e%3c/circle%3e %3c/g%3e %3c/g%3e%3c/svg%3e"},style:{display:"block","pointer-events":"none",position:"absolute",transform:"translate(-50%, -50%)"}}]}).el;return o.el=r,o}return i(e,t),e.prototype._getTextBounding=function(){var t,e;return{width:(null===(t=this.el)||void 0===t?void 0:t.offsetWidth)||0,height:(null===(e=this.el)||void 0===e?void 0:e.offsetHeight)||0}},e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x,i=t.y,o=this.position,r=this._getTextBounding(),n=r.width,s=r.height;return{x:e+o[0],y:i+o[1],width:n,height:s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x,i=t.y,o=this.position,r=this._getTextBounding(),n=r.width,s=r.height;return{x:e+o[0]-this.rectWithStrokePadding/2,y:i+o[1]-this.rectWithStrokePadding/2,width:n+this.rectWithStrokePadding,height:s+this.rectWithStrokePadding}},e.prototype.isPointInPath=function(t,e){var i=this._props,o=i.cx,r=i.cy,n=this.position,s=this._getTextBounding(),a=s.width,h=s.height,c=o+n[0],l=r+n[1];return t>=c&&t<=c+a&&e>=l&&e<=l+h},e.prototype.buildPath=function(t,e){},e.prototype.addPosition=function(t,e){this.position[0]+=t,this.position[1]+=e,this.setPosition(this.position[0],this.position[1])},e.prototype.setPosition=function(t,e){var i=this;this.el&&(this.position=[t,e],document.querySelectorAll(".board-laser_item").forEach((function(o){o.getAttribute("data-uid")===i.id&&(i.el=o,i.el.style.transform="translate("+(i.props.cx+t)+"px, "+(i.props.cy+e)+"px) scale(1.0)")})))},e.prototype.buildElement=function(t){var e;t instanceof HTMLElement?t.appendChild(this.el):"string"==typeof t&&(null===(e=document.querySelector("#"+t))||void 0===e||e.appendChild(this.el))},e.prototype.dispose=function(){var t;null===(t=this.el)||void 0===t||t.remove()},e}(N),H=function(t){function e(e,i){return t.call(this,e,_.LINE,i.props||{x:0,y:0,x1:0,y1:0},i.position||[0,0],i.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this}return i(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x,i=t.y,o=t.x1,r=t.y1,n=this.position,s=this.style.lineWidth,a=s/2,h=(i<r?i:r)-a;return{x:(e<o?e:o)-a+n[0],y:h+n[1],width:Math.floor(Math.abs(o-e))+s,height:Math.floor(Math.abs(r-i))+s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x,i=t.y,o=t.x1,r=t.y1,n=this.position,s=this.style.lineWidth,a=s/2,h=(i<r?i:r)-a;return{x:(e<o?e:o)-a+n[0]-this.rectWithStrokePadding/2,y:h+n[1]-this.rectWithStrokePadding/2,width:Math.floor(Math.abs(o-e))+this.rectWithStrokePadding+s,height:Math.floor(Math.abs(r-i))+this.rectWithStrokePadding+s}},e.prototype.isPointInPath=function(t,e){var i=this._props,o=i.x,r=i.y,n=i.x1,s=i.y1,a=this.position,h=this.style.lineWidth/2,c=(o<n?o:n)+a[0]-h,l=(r<s?r:s)+a[1]-h,d=(o<n?n:o)+a[0]+h,p=(r<s?s:r)+a[1]+h;return t>=c&&t<=d&&e>=l&&e<=p},e.prototype.buildPath=function(e,i){e.save(),t.prototype.buildPath.call(this,e,i);var r=o(o({},this.props),null==i?void 0:i.props),n=(null==i?void 0:i.position)||this.position;if(r){var s=r.x,a=r.y,h=r.x1,c=r.y1;e.beginPath(),e.moveTo(s+n[0],a+n[1]),e.lineTo(h+n[0],c+n[1]),e.stroke()}e.restore()},e}(N),F=function(t){function e(e,i){return t.call(this,e,_.RECT,o({x1:0,y1:0,x2:0,y2:0},i.props),i.position||[0,0],o({fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"},i.style))||this}return i(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x1,i=t.y1,o=t.x2,r=t.y2,n=this.position,s=this.style.lineWidth,a=s/2,h=e<o?e:o-a,c=i<r?i:r-a,l=Math.abs(o-e)+s,d=Math.abs(r-i)+s;return{x:h+n[0],y:c+n[1],width:l+s,height:d+s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x1,i=t.y1,o=t.x2,r=t.y2,n=this.position,s=this.style.lineWidth,a=s/2,h=(e<o?e:o)-a,c=(i<r?i:r)-a,l=Math.abs(o-e)+s,d=Math.abs(r-i)+s;return{x:h+n[0]-this.rectWithStrokePadding/2,y:c+n[1]-this.rectWithStrokePadding/2,width:l+this.rectWithStrokePadding,height:d+this.rectWithStrokePadding}},e.prototype.isPointInPath=function(t,e){var i=this._props,o=i.x1,r=i.y1,n=i.x2,s=i.y2,a=this.position,h=this.style.lineWidth/2,c=(o<n?o:n)+a[0]-h,l=(r<s?r:s)+a[1]-h,d=(o<n?n:o)+a[0]+h,p=(r<s?s:r)+a[1]+h;return t>=c&&t<=d&&e>=l&&e<=p},e.prototype.buildPath=function(e,i){e.save(),t.prototype.buildPath.call(this,e,i);var r=o(o({},this.props),null==i?void 0:i.props),n=(null==i?void 0:i.position)||this.position;if(r){var s=r.x1,a=r.y1,h=r.x2,c=r.y2,l=(s<h?s:h)+n[0],d=(a<c?a:c)+n[1];e.beginPath(),e.rect(l,d,Math.abs(h-s),Math.abs(c-a)),e.stroke()}e.restore()},e}(N),V=document.createElement("canvas").getContext("2d"),K=function(t,e,i){var o=t.replace(/\n|\r/gi,"<br />").split("<br />"),r=[],n=0;return o.forEach((function(t,o){var s=q(t,e,i),c=s.width,l=s.list;n<c&&(n=c),r.push.apply(r,h([],a(l)))})),{width:n,height:r.length*e.lineHeight,list:r}},q=function(t,e,i){var o=0,r=[],n=e.fontStyle,s=e.fontWeight,a=e.fontSize,h=e.fontFamily,c=e.lineHeight;if(V.font=n+" "+s+" "+a+"px/"+c+"px "+h,V.measureText(t).width<=i){var l=Math.ceil(V.measureText(t).width);r.push({text:t,width:l}),o=l>a?l:a}else for(var d="",p=0,u=0;u<t.length;u++){d+=t[u];var _=V.measureText(d).width;if(_===i){l=Math.ceil(V.measureText(t.substring(p,u+1)).width);r.push({text:t.substring(p,u+1),width:l}),o<l&&(o=l),p=u+1,d=""}else if(_>i){l=Math.ceil(V.measureText(t.substring(p,u)).width);r.push({text:t.substring(p,u),width:l}),o<l&&(o=l),p=u;var f=t.substring(p),v=Math.ceil(V.measureText(f).width);if(v<=i){r.push({text:f,width:v}),o<v&&(o=v);break}d=t[u]}else if(u===t.length-1){l=Math.ceil(V.measureText(t.substring(p)).width);r.push({text:t.substring(p),width:l}),o<l&&(o=l)}}return{list:r,width:o}},z=function(t){function e(e,i){return t.call(this,e,_.TEXT,o({text:"",x:0,y:0,width:0,height:0,maxWidth:0,maxHeight:0,fontSize:12,lineHeight:12},i.props),i.position||[0,0],o({fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000",textFill:"#000000",textStroke:"#000000",fontFamily:"customFontFamily, sans-serif, serif, monospace"},i.style))||this}return i(e,t),e.prototype._getTextBounding=function(){var t=U({kind:"canvas"}).el.getContext("2d"),e=this._props,i=e.text,o=e.fontSize,r=e.lineHeight,n=this.style;n.lineWidth;var s=n.textStyle,a=n.textWeight,h=n.textFill,c=n.textStroke,l=n.fontFamily;if(c&&(t.strokeStyle=c),h&&(t.fillStyle=h),o&&(t.font=s+" "+a+" "+o+"px "+l),i){var d=K(i,{fontSize:o,lineHeight:r,fontFamily:l},this.props.maxWidth),p=d.width,u=d.height;return d.list,{width:p,height:u}}return{width:0,height:o||0}},e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x,i=t.y,o=this.position,r=this._getTextBounding(),n=r.width,s=r.height;return{x:e+o[0],y:i+o[1],width:n,height:s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x,i=t.y,o=this.position,r=this._getTextBounding(),n=r.width,s=r.height;return{x:e+o[0]-this.rectWithStrokePadding/2,y:i+o[1]-this.rectWithStrokePadding/2,width:n+this.rectWithStrokePadding,height:s+this.rectWithStrokePadding}},e.prototype.isPointInPath=function(t,e){var i=this._props,o=i.x,r=i.y,n=this.position,s=this._getTextBounding(),a=s.width,h=s.height,c=o+n[0],l=r+n[1];return t>=c&&t<=c+a&&e>=l&&e<=l+h},e.prototype.setFontSize=function(t){this.style.fontSize=t,this._calculateShapeRectBounding(),this._calculateShapeRectWithStrokeBounding()},e.prototype.buildPath=function(e,i){t.prototype.buildPath.call(this,e,i);var r=o(o({},this.props),null==i?void 0:i.props);if((null==i?void 0:i.position)||this.position,r&&r.text){e.save();var n=r.text,s=r.fontSize,a=r.lineHeight,h=r.maxWidth,c=this._rect,l=c.x,d=c.y,p=c.width,u=c.height,_=o(o({},this.style),null==i?void 0:i.style),f=_.textStyle,v=_.textWeight,E=_.textFill,g=_.textStroke,y=_.fontFamily;g&&(e.fillStyle=g),E&&(e.fillStyle=E),s&&(e.font=f+" "+v+" "+s+"px "+y),e.beginPath(),e.rect(l,d,p,u);var S=K(n,{fontSize:s,lineHeight:a,fontStyle:f,fontWeight:v,fontFamily:y},h);S.width,S.height,S.list.forEach((function(t,i){e.fillText(t.text,l,d+(i+1)*a)})),e.restore()}},e}(N),j=function(t,e){var i="YYYY-MM-DD hh:mm:ss";if("number"!=typeof t)throw new Error("[timesToDate]: timestamp must be number");e&&"string"==typeof e&&(i=e);var o=t||Date.now(),r=new Date(o)||new Date(o),n=r.getFullYear(),s=r.getMonth()+1,a=r.getDate(),h=r.getHours(),c=r.getMinutes(),l=r.getSeconds(),d=r.getMilliseconds();return i.indexOf("YYYY")>-1&&(i=i.replace("YYYY",(function(t){return""+n}))),i.indexOf("MM")>-1?i=i.replace("MM",(function(t){return s<10?"0"+s:""+s})):i.indexOf("M")>-1&&(i=i.replace("M",(function(t){return""+s}))),i.indexOf("DD")>-1?i=i.replace("DD",(function(t){return a<10?"0"+a:""+a})):i.indexOf("D")>-1&&(i=i.replace("D",(function(t){return""+a}))),i.indexOf("hh")>-1?i=i.replace("hh",(function(t){return h<10?"0"+h:""+h})):i.indexOf("h")>-1&&(i=i.replace("h",(function(t){return""+h}))),i.indexOf("mm")>-1?i=i.replace("mm",(function(t){return c<10?"0"+c:""+c})):i.indexOf("m")>-1&&(i=i.replace("m",(function(t){return""+c}))),i.indexOf("ss")>-1?i=i.replace("ss",(function(t){return l<10?"0"+l:""+l})):i.indexOf("s")>-1&&(i=i.replace("s",(function(t){return""+l}))),i.indexOf("ms")>-1&&(i=i.replace("ms",(function(){return""+d}))),i.indexOf("AP")>-1&&(i=i.replace("AP",(function(){return h>12?"PM":"AM"}))),i},Y=function(t,e){return Math.round(Number(t+"e"+e))/Math.pow(10,e)},J=function(t,e){var i=a(t,4),o=i[0],r=i[1],n=i[2],s=i[3],h=e||30,c=180*Math.atan2(r-s,o-n)/Math.PI,l=(c+30)*Math.PI/180,d=(c-30)*Math.PI/180;return[[o,r],[n,s],[n+h*Math.cos(l),s+h*Math.sin(l)],[n+h*Math.cos(d),s+h*Math.sin(d)]]},X=function(t){void 0===t&&(t=13),t>20&&(t=20);var e=Math.ceil(Math.random()*Math.pow(10,t));return e<Math.pow(10,t-1)?X(t):e};!function(t){t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARNING=2]="WARNING",t[t.ERROR=3]="ERROR",t[t.NONE=4]="NONE"}(x||(x={}));var Q=function(){function t(){this.logPrefix="SupLogger",this.logLevel=x.NONE,this.uploadServeTranslators=[],this.DEBUG=x.DEBUG,this.INFO=x.INFO,this.WARNING=x.WARNING,this.ERROR=x.ERROR,this.NONE=x.NONE}return t.prototype.setLogLevel=function(t,e){e&&(this.logPrefix=e),"number"==typeof t&&t>-1&&t<5&&(this.logLevel=t)},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(this.logLevel>x.ERROR&&this.logLevel!==x.NONE||this.logLevel===x.NONE)){var i=t,o=Date.now();i.unshift("["+j(o,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [ERROR]:%c","color: #b00020; font-weight: bold;","color: #dc3545;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(t){t({type:"error",params:i,timestamp:o},(function(){console.error.apply(console,i)}))})):console.error.apply(console,i)}},t.prototype.warning=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(this.logLevel>x.WARNING&&this.logLevel!==x.NONE||this.logLevel===x.NONE)){var i=t,o=Date.now();i.unshift("["+j(o,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [WARNING]:","color: #ffc107; font-weight: bold;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(t){t({type:"warning",params:i,timestamp:o},(function(){console.warn.apply(console,i)}))})):console.warn.apply(console,i)}},t.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(this.logLevel>x.INFO&&this.logLevel!==x.NONE||this.logLevel===x.NONE)){var i=t,o=Date.now();i.unshift("["+j(o,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [INFO]:","color:  #007bff; font-weight: bold;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(t){t({type:"info",params:i,timestamp:o},(function(){console.log.apply(console,i)}))})):console.log.apply(console,i)}},t.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(this.logLevel>x.DEBUG&&this.logLevel!==x.NONE||this.logLevel===x.NONE)){var i=t,o=Date.now();i.unshift("["+j(o,"hh:mm:ss.ms")+"] %c"+this.logPrefix+" [DEBUG]:","color:#6facff;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(t){t({type:"debug",params:i,timestamp:o},(function(){console.log.apply(console,i)}))})):console.log.apply(console,i)}},t}(),$=new Q;$.setLogLevel($.DEBUG,"ar-whiteboard");var Z,tt=Array.prototype,et=function(){function t(){this._events={},this.addListener=this.on}return t.prototype.getListeners=function(t){return this._events[t]?tt.map.call(this._events[t],(function(t){return t.listener})):[]},t.prototype.on=function(t,e){this._events[t]||(this._events[t]=[]);var i=this._events[t];-1===this._indexOfListener(i,e)&&i.push({listener:e,once:!1})},t.prototype.once=function(t,e){this._events[t]||(this._events[t]=[]);var i=this._events[t];-1===this._indexOfListener(i,e)&&i.push({listener:e,once:!0})},t.prototype.off=function(t,e){this._events[t]||(this._events[t]=[]);var i=this._events[t],o=this._indexOfListener(i,e);-1!==o&&tt.splice.call(i,o,1)},t.prototype.removeAllListeners=function(t){t?delete this._events[t]:this._events={}},t.prototype.emit=function(t){for(var e,i,o=[],r=1;r<arguments.length;r++)o[r-1]=arguments[r];this._events[t]||(this._events[t]=[]);var n=this._events[t];try{for(var a=s(n),h=a.next();!h.done;h=a.next()){var c=h.value;c.once&&this.off(t,c.listener),c.listener.apply(this,o||[])}}catch(t){e={error:t}}finally{try{h&&!h.done&&(i=a.return)&&i.call(a)}finally{if(e)throw e.error}}},t.prototype._indexOfListener=function(t,e){for(var i=t.length;i--;)if(t[i].listener===e)return i;return-1},t}(),it=function(){function t(t,e,i){void 0===e&&(e=""),this.name="ArWhiteBoardException",this.code=t;var o="ArWhiteBoardError".concat(": ");this.message=e?o.concat(e):o,this.data=i}return t.prototype.toString=function(){return this.data?"".concat(this.message," data: ").concat(JSON.stringify(this.data)):this.message},t}(),ot=function(){var t,e,i=navigator.userAgent;try{for(var o=s(["Android","iPhone","SymbianOS","Windows Phone","iPod","iPad"]),r=o.next();!r.done;r=o.next()){var n=r.value;if(i.indexOf(n)>=0)return!0}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=o.return)&&e.call(o)}finally{if(t)throw t.error}}return!1},rt=function(e){function s(t,i){var r,n=e.call(this)||this;if(n.options={width:1920,height:1080,globalBackgroundColor:"#ffffff",backgroundColor:"",backgroundImage:"",backgroundImageFillMode:"contain",backgroundH5:"",progressBarUrl:"",ratio:"16:9",scale:100},n._boxWidth=0,n._boxHeight=0,n._width=0,n._height=0,n._controlBoxPosition=[0,0,0,0],n.selectStartPosition=[],n.selectLatestMovePosition=[],n._handleMouseDown=function(){},n._handleMouseMove=function(){},n._handleMouseUp=function(){},n._handleControlBoxMouseDown=function(){},n._handleControlBoxMouseMove=function(){},n._handleControlBoxMouseUp=function(){},t instanceof HTMLElement)r=t;else{if("string"!=typeof t||!document.querySelector("#"+t))throw new it(c.INVALID_PARAMS,"selector must be HTMLElement or Element id");r=document.querySelector("#"+t)}return n._rootDom=r,n.options=o(o(o({},n.options),i),{width:n._rootDom.clientWidth,height:n._rootDom.clientHeight}),n._calculateCanvasWidthAndHeight(),n.init(),n}return i(s,e),Object.defineProperty(s.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"boxWidth",{get:function(){return this._boxWidth},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"boxHeight",{get:function(){return this._boxHeight},enumerable:!1,configurable:!0}),s.prototype.getRetinaScaling=function(){return window.devicePixelRatio||window.webkitDevicePixelRatio||window.mozDevicePixelRatio||1},s.prototype.init=function(){var t=U({key:"canvasBox",kind:"div",props:{class:"board_wrap"},style:{position:"relative",width:this._boxWidth+"px",height:this._boxHeight+"px",top:this._rootDom.offsetHeight/2+"px",left:this._rootDom.offsetWidth/2+"px",transform:"translate(-50%, -50%)",padding:"0px",margin:"0px","border-width":"0px",overflow:"hidden"},children:[{key:"cacheCanvas",kind:"canvas",props:{class:"board-cache_canvas",width:this._width,height:this._height},children:[]},{key:"canvas",kind:"canvas",props:{class:"board_canvas",width:this._width,height:this._height},children:[]},{key:"canvasBackgroundImage",kind:"img",props:{class:"board_background_image",src:""},children:[]},{key:"canvasBackground",kind:"div",props:{class:"board_background_wrap",width:"100%",height:"100%"},children:[]},{key:"cursorWrap",kind:"div",props:{class:"cursor_wrap_view",width:"100%",height:"100%"},children:[]},{key:"controlWrap",kind:"div",props:{class:"control_wrap_view",width:"100%",height:"100%"},children:[{key:"controlBox",kind:"div",children:[]}]},{key:"loading",kind:"img",props:{class:"board_loading",src:this.options.progressBarUrl},children:[]},{key:"textBox",kind:"div",props:{class:"board_text_box",width:"100%",height:"100%"},children:[{key:"textInput",kind:"textarea",props:o({class:"board-text_input"},p.TEXT_INPUT_ELEMENT_OPTIONS.props)}]},{key:"canvasH5",kind:"iframe",props:{class:"board_webview",width:"100%",height:"100%",src:""},children:[]}]}),e=t.el,i=t.canvasBox,r=t.canvas,n=t.cacheCanvas,s=t.canvasBackground,a=t.canvasBackgroundImage,h=t.canvasH5,c=t.textBox;t.textInput;var l=t.cursorWrap,d=t.loading,u=t.controlWrap,_=t.controlBox;this._rootDom.appendChild(e),this._canvasBox=i,this._canvas=r,this._cacheCanvas=n,this._canvasBgWrap=s,this._canvasBgImg=a,this._canvasBgH5=h,this._cursorWrap=l,this._loading=d,this._textBox=c,this._controlWrap=u,this._controlBox=_,this._canvasCtx=r.getContext("2d"),this._cacheCanvasCtx=n.getContext("2d"),this._handleControlBoxMouseDown=this.handleControlBoxMouseDown.bind(this),this._handleControlBoxMouseMove=this.handleControlBoxMouseMove.bind(this),this._handleControlBoxMouseUp=this.handleControlBoxMouseUp.bind(this),this._controlWrap.ontouchstart=this._controlWrap.onmousedown=this._handleControlBoxMouseDown,this._controlWrap.ontouchmove=this._controlWrap.onmousemove=this._handleControlBoxMouseMove,this._controlWrap.ontouchend=this._controlWrap.onmouseup=this._controlWrap.onmouseout=this._handleControlBoxMouseUp,this._canvas.oncontextmenu=function(t){t.preventDefault(),t.stopPropagation()},this.startHandleMoveEvent()},s.prototype.destroy=function(){this._rootDom.innerHTML=""},s.prototype.getSnapShortImage=function(){return r(this,void 0,void 0,(function(){var e,i,o=this;return n(this,(function(r){switch(r.label){case 0:return e=U({kind:"canvas",props:{width:this.width,height:this.height},style:{}}).el,(i=e.getContext("2d")).fillStyle=this.options.backgroundColor,i.fillRect(0,0,this.width,this.height),this.options.backgroundImage?[4,new Promise((function(e,r){var n=new Image;n.crossOrigin="anonymous",n.src=o.options.backgroundImage+"?timeStep="+Date.now(),n.onload=function(){if("contain"===o.options.backgroundImageFillMode){(s=Math.min(o._boxWidth/n.width,o._boxHeight/n.height))>1&&(s=1);var t=o._boxWidth/2-n.width/2*s,r=o._boxHeight/2-n.height/2*s;i.drawImage(n,t,r,n.width*s,n.height*s)}else if("cover"===o.options.backgroundImageFillMode){var s=Math.max(o._boxWidth/n.width,o._boxHeight/n.height);t=o._boxWidth/2-n.width/2*s,r=o._boxHeight/2-n.height/2*s;i.drawImage(n,t,r,n.width*s,n.height*s)}else"fill"===o.options.backgroundImageFillMode&&i.drawImage(n,0,0,o._boxWidth,o._boxHeight);document.body.appendChild(n),e()},n.onerror=function(e){var i=new it(t.EBoardErrorCode.GET_SNAP_SHORT_FAILED,"Check whether the image resource complies with the CORS policy.");$.error(i),r(i)}}))]:[3,2];case 1:r.sent(),r.label=2;case 2:return i.drawImage(this._cacheCanvas,0,0),[2,e.toDataURL("image/png")]}}))}))},s.prototype.appendChild=function(t){this._canvasBox.appendChild(t)},s.prototype.setCanvasBGColor=function(t){this.options.backgroundColor=t,this._canvasBgWrap.style.backgroundColor=t},s.prototype.setCanvasBGImage=function(t,e){void 0===e&&(e="contain"),t?(this.options.backgroundImage=t,this.options.backgroundImageFillMode=e,this._canvasBgImg.src=t,this._canvasBgImg.style.visibility="visible",this._canvasBgImg.classList.remove("contain","cover","fill"),["contain","cover","fill"].includes(e)&&this._canvasBgImg.classList.add(e)):(this.options.backgroundImage="",this.options.backgroundImageFillMode="contain",this._canvasBgImg.classList.remove("contain","cover","fill"),this._canvasBgImg.removeAttribute("src"),this._canvasBgImg.style.visibility="hidden")},s.prototype.setCanvasBGH5=function(t){t?(this.options.backgroundH5=t,this._canvasBgH5.src=t,this._canvasBgH5.style.visibility="visible"):(this.options.backgroundH5="",this._canvasBgH5.src="",this._canvasBgH5.style.visibility="hidden")},s.prototype.createTextInput=function(t){this._textBox.appendChild(t)},s.prototype.showControlWrap=function(){this._controlWrap.style.display="block",this._controlWrap.style.zIndex="100"},s.prototype.hideControlWrap=function(){this._controlWrap.style.display="block",this._controlWrap.style.zIndex="0"},s.prototype.setControlBoxSize=function(t){var e=t[0],i=t[1],o=t[2],r=t[3];this._controlBox.style.width=o-e+"px",this._controlBox.style.height=r-i+"px",this.setControlBoxPosition(t)},s.prototype.setControlBoxPosition=function(t){var e=(this.boxWidth-this.width)/2,i=(this.boxHeight-this.height)/2,o=t[0]+e,r=t[1]+i;this._controlBoxPosition=t,this._controlBox.style.transform="translateX("+o+"px) translateY("+r+"px) rotate(0deg)"},s.prototype.showLoading=function(){this._loading.style.display="block"},s.prototype.hideLoading=function(){this._loading.style.display="none"},s.prototype.renderSize=function(){this._calculateCanvasWidthAndHeight(),this._canvasBox.style.width=this._boxWidth+"px",this._canvasBox.style.height=this._boxHeight+"px",this._canvasBox.style.top=this._rootDom.offsetHeight/2+"px",this._canvasBox.style.left=this._rootDom.offsetWidth/2+"px",this._canvas.width=this._cacheCanvas.width=this._width,this._canvas.height=this._cacheCanvas.height=this._height,this._canvas.style.width=this._cacheCanvas.style.width=this._width+"px",this._canvas.style.height=this._cacheCanvas.style.height=this._height+"px",this._boxWidth>this._width?(this._canvas.style.marginTop=this._cacheCanvas.style.marginTop=(this._boxHeight-this._height)/2+"px",this._canvas.style.marginLeft=this._cacheCanvas.style.marginLeft=(this._boxWidth-this._width)/2+"px"):(this._canvas.style.marginTop=this._cacheCanvas.style.marginTop="0px",this._canvas.style.marginLeft=this._cacheCanvas.style.marginLeft="0px")},s.prototype.startHandleMoveEvent=function(){this._handleMouseDown=this.handleMouseDown.bind(this),this._handleMouseMove=this.handleMouseMove.bind(this),this._handleMouseUp=this.handleMouseUp.bind(this),ot()?(this._canvas.addEventListener("touchstart",this._handleMouseDown,!1),this._canvas.addEventListener("touchmove",this._handleMouseMove,!1),this._canvas.addEventListener("touchend",this._handleMouseUp,!1),this._canvas.addEventListener("touchcancel",this._handleMouseUp,!1)):(this._canvas.addEventListener("mouseenter",this._handleMouseDown,!1),this._canvas.addEventListener("mousedown",this._handleMouseDown,!1),this._canvas.addEventListener("mousemove",this._handleMouseMove,!1),this._canvas.addEventListener("mouseup",this._handleMouseUp,!1),this._canvas.addEventListener("mouseout",this._handleMouseUp,!1))},s.prototype.stopHandleMoveEvent=function(){ot()?(this._canvas.removeEventListener("touchstart",this._handleMouseDown,!1),this._canvas.removeEventListener("touchmove",this._handleMouseMove,!1),this._canvas.removeEventListener("touchend",this._handleMouseUp,!1),this._canvas.removeEventListener("touchcancel",this._handleMouseUp,!1)):(this._canvas.removeEventListener("mousedown",this._handleMouseDown,!1),this._canvas.removeEventListener("mousemove",this._handleMouseMove,!1),this._canvas.removeEventListener("mouseup",this._handleMouseUp,!1),this._canvas.removeEventListener("mouseout",this._handleMouseUp,!1))},s.prototype._calculateCanvasWidthAndHeight=function(){var t=this.options,e=t.ratio,i=t.scale,o=e.split(":"),r=Number(o[0]),n=Number(o[1]),s=this._rootDom.offsetWidth,a=this._rootDom.offsetHeight,h=0;h=s*n/r<a?s:a*r/n,this._boxWidth=h*(i/100),this._boxHeight=this._boxWidth*n/r;var c,l,d=this._boxWidth;c=d,l=d*n/r,this._width=c,this._height=l},s.prototype.handleMouseDown=function(t){},s.prototype.handleMouseMove=function(t){},s.prototype.handleMouseUp=function(t){},s.prototype.handleMouseOut=function(t){},s.prototype.handleControlBoxMouseDown=function(t){},s.prototype.handleControlBoxMouseMove=function(t){},s.prototype.handleControlBoxMouseUp=function(t){},s.prototype.handleControlBoxMouseOut=function(t){},s.basicWidth=1920,s.basicHeight=1080,s}(et),nt={Arrow:P,Circle:M,Ellipse:k,FreeDraw:W,LaserPointer:G,Line:H,Rect:F,Text:z},st=2e3,at=function(e){function r(i,o){var r=e.call(this,i,o)||this;if(r._id="",r.uid="",r._enabled=!0,r._toolType=t.EBoardToolType.NONE,r._brushColor="#000000",r._brushThin=5,r._textStyle="normal",r._textWeight="normal",r._textSize=16,r._textColor="#333333",r._selectBoxColor="#ababab",r._brushCursor="default",r._selectShapes=[],r._laserPointer=null,r._textInput=null,r._temporaryList=new Map,r._displayList=new Map,r._canRedoList=[],r._canUndoList=[],r._mouseDown=!1,r._startPosition=[0,0],r._endPosition=[0,0],r._latestMovePosition=[],r._currentShape=null,r._selectShape=null,r._needUpdateShapeData=null,o){var n=o.brushColor,s=o.brushThin;o.scale;var a=o.textStyle,h=o.textSize,c=o.textColor,l=o.selectBoxColor;if(n&&(r._brushColor=n),s&&(r._brushThin=s),a){var d="normal",p="normal";switch(a){case t.EBoardTextStyle.BOLD:p="bold";break;case t.EBoardTextStyle.ITALIC:d="italic";break;case t.EBoardTextStyle.BOLD_ITALIC:d="italic",p="bold"}r._textStyle=d,r._textWeight=p}h&&(r._textSize=h),c&&(r._textColor=c),l&&(r._selectBoxColor=l)}return r}return i(r,e),Object.defineProperty(r.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canUndoList",{get:function(){return this._canUndoList},set:function(t){this._canUndoList=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canRedoList",{get:function(){return this._canRedoList},set:function(t){this._canRedoList=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"brushColor",{get:function(){return this._brushColor},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"brushType",{get:function(){return this._toolType},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"brushThin",{get:function(){return this._brushThin},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"backgroundColor",{get:function(){return this.options.backgroundColor},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"backgroundImage",{get:function(){return this.options.backgroundImage},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"backgroundImageFillMode",{get:function(){return this.options.backgroundImageFillMode},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"brushId",{get:function(){return this.uid+"_"+Date.now()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"selectPenId",{get:function(){return"selector_"+(st+=1)},enumerable:!1,configurable:!0}),r.prototype.setEnable=function(t){"boolean"==typeof t?this._enabled!==t&&(this._enabled=t,$.info("set board enable as "+t)):$.info("set board enable failed")},r.prototype.getEnable=function(){return this._enabled},r.prototype.getNeedUpdateShapeData=function(){var t=this._needUpdateShapeData;return this._needUpdateShapeData=null,t},r.prototype.setBrushType=function(e){var i=this;if(e!==t.EBoardToolType.NONE&&e!==t.EBoardToolType.SELECT&&e!==t.EBoardToolType.FREE_DRAW&&e!==t.EBoardToolType.TEXT&&e!==t.EBoardToolType.RECT&&e!==t.EBoardToolType.LINE&&e!==t.EBoardToolType.ELLIPSE&&e!==t.EBoardToolType.ARROW&&e!==t.EBoardToolType.ERASER&&e!==t.EBoardToolType.LASER_POINTER)throw new it(c.INVALID_PARAMS);$.info("set brush type as "+e),this._setBrushCursor(e),this._selectShapes.length>0&&(this._displayList.forEach((function(t,e){i._selectShapes.includes(e)&&i.drawToCachePainter(t)})),this._selectShapes=[],this.hideControlWrap(),this._renderTemporaryCanvas())},r.prototype.setBrushColor=function(t){if("string"!=typeof t)throw new it(c.INVALID_PARAMS);$.info("set brush color as "+t),this._brushColor=t},r.prototype.setBrushThin=function(t){if(!("number"==typeof t&&t>=1&&t<=20))throw new it(c.INVALID_PARAMS);this._brushThin=t,$.info("set brush thin as "+t)},r.prototype.setTextStyle=function(){},r.prototype.getTextStyle=function(){},r.prototype.setLineStyle=function(){},r.prototype.getLineStyle=function(){},r.prototype.setTextSize=function(t){this._textSize=t},r.prototype.getTextSize=function(){return this._textSize},r.prototype.setTextColor=function(t){this._textColor=t},r.prototype.getTextColor=function(){return this._textColor},r.prototype.setBoardRatio=function(t){this.options.ratio=t,this.renderSize()},r.prototype.getBoardRatio=function(){return this.options.ratio},r.prototype.setSelectBoxColor=function(t){this._selectBoxColor=t},r.prototype.scalePainter=function(t){this.options.scale=t,this.renderSize()},r.prototype.undo=function(){var t=this._canUndoList.pop();if(t){var e=t.type;t.shapes,this._canRedoList.push(t),this._selectShapes=[],this.renderControlBox();var i=t.shapes[0],o=new nt[i.type](i.id,{props:i._props,position:i.position,style:i.style}),r=void 0;if(e===f.ADD_SHAPE){var n={pIds:[o.id]};r={bId:this.id,action:f.DELETE_SHAPE,data:n},this.removeElement(o.id)}else if(e===f.DELETE_SHAPE){var s={pId:o.id,shape:o.type,props:o.props,position:o.position,style:o.style,width:this.width,height:this.height,lts:Date.now()};r={bId:this.id,action:f.ADD_SHAPE,data:s},this.addElement(o)}else if(e===f.MOVE_SHAPE){var h=t.offset,c=t.shapes,l=a(h,2),d=l[0],p=l[1];this.moveElement(c.map((function(t){return t.id})),[-1*d*this.width,-1*p*this.height]);var u={pIds:c.map((function(t){return t.id})),offset:[-1*d,-1*p]};r={bId:this.id,action:f.MOVE_SHAPE,data:u}}this.emit("reportContent",r)}},r.prototype.redo=function(){var t=this._canRedoList.pop();if(t){this._canUndoList.push(t);var e=t.shapes[0],i=new nt[e.type](e.id,{props:e._props,position:e.position,style:e.style}),o=void 0;if(t.type===f.ADD_SHAPE){var r={pId:i.id,shape:i.type,props:i.props,position:i.position,style:i.style,width:this.width,height:this.height,lts:Date.now()};o={bId:this.id,action:f.ADD_SHAPE,data:r},this.addElement(i)}else if(t.type===f.DELETE_SHAPE){var n={pIds:[i.id]};o={bId:this.id,action:f.DELETE_SHAPE,data:n},this.removeElement(i.id)}else if(t.type===f.MOVE_SHAPE){var s=t.offset,h=t.shapes,c=a(s,2),l=c[0],d=c[1];this.moveElement(h.map((function(t){return t.id})),[l*this.width,d*this.height]);var p={pIds:h.map((function(t){return t.id})),offset:[l,d]};o={bId:this.id,action:f.MOVE_SHAPE,data:p}}this.emit("reportContent",o)}},r.prototype.addElement=function(t){if(this._displayList.get(t.id))throw Error("can not add again");if(!this._temporaryList.get(t.id)){if(t instanceof G){var e=document.querySelectorAll(".board-laser_item"),i=!1;e.forEach((function(e){e.getAttribute("data-uid")===t.id&&(i=!0)})),!i&&t.buildElement(this._cursorWrap)}else this.drawToCachePainter(t);this._displayList.set(t.id,t)}},r.prototype.removeElement=function(t){var e=this,i=this._displayList.get(t);if(i){this._displayList.delete(t);var o=this._selectShapes.findIndex((function(e){return e===t}));~o&&this._selectShapes.splice(o,1),this.renderControlBox(),i instanceof G?document.querySelectorAll(".board-laser_item").forEach((function(e){e.getAttribute("data-uid")===t&&e.remove()})):(this.clearCachePainter(),this._displayList.forEach((function(t){e.drawToCachePainter(t)})))}},r.prototype.moveElement=function(t,e){var i=this,o=a(e,2),r=o[0],n=o[1];this.clearCachePainter(),this._displayList.forEach((function(e,o){t.includes(e.id)?(null==e?void 0:e.type)===_.LASER_POINTER?(null==e||e.attr("position",[r,n]),e.setPosition(r,n)):(null==e||e.attr("position",[e.position[0]+r,e.position[1]+n]),i.drawToCachePainter(e)):i.drawToCachePainter(e)}))},r.prototype.refreshElement=function(t){var e=this._displayList.get(t);e&&e.buildPath(this._canvasCtx,e)},r.prototype.findElement=function(t){return this._displayList.get(t)},r.prototype.renderControlBox=function(){var t=this;if(this._selectShapes.length>0){var e=[],i=[],o=[],r=[];this._selectShapes.forEach((function(n){var s=t._displayList.get(n),a=null==s?void 0:s.getBoundingRect();e.push(a.x),i.push(a.y),o.push(a.x+a.width),r.push(a.y+a.height)})),this._controlBoxPosition=[Math.min.apply(Math,h([],a(e))),Math.min.apply(Math,h([],a(i))),Math.max.apply(Math,h([],a(o))),Math.max.apply(Math,h([],a(r)))],this.setControlBoxSize(this._controlBoxPosition),this.showControlWrap()}else this.hideControlWrap()},r.prototype.clearCanvas=function(){this.clearPainter(),this.clearCachePainter(),this._displayList.clear()},r.prototype.clearAllLaserPointer=function(){this._cursorWrap.innerHTML=""},r.prototype.clearOtherLaserPointer=function(){var t=this;this._displayList.forEach((function(e){e instanceof G&&e.id!==t.uid&&document.querySelectorAll(".board-laser_item").forEach((function(t){t.getAttribute("data-uid")!==e.id&&t.remove()}))}))},r.prototype.clearSelfLaserPoint=function(){var t=this;this._displayList.forEach((function(e){e instanceof G&&e.id!==t.uid&&document.querySelectorAll(".board-laser_item").forEach((function(t){t.getAttribute("data-uid")===e.id&&t.remove()}))}))},r.prototype.clear=function(t){void 0===t&&(t=!1),this.clearPainter(),this.clearCachePainter(),this._displayList.clear(),t||(this._selectShapes=[],this.hideControlWrap())},r.prototype.reset=function(){this.clearPainter(),this.clearCachePainter(),this._displayList.clear(),this._temporaryList.clear(),this._canUndoList=[],this._canRedoList=[],this._selectShape&&(this._selectShape=null),this._currentShape&&(this._toolType===t.EBoardToolType.FREE_DRAW?this._currentShape.props.points.length>1?(this._canUndoList.push({type:f.ADD_SHAPE,shapes:[this._currentShape]}),this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null):this.removeElement(this._currentShape.id):(this._canUndoList.push({type:f.ADD_SHAPE,shapes:[this._currentShape]}),this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null),this._currentShape=null)},r.prototype.clearAll=function(){this.clear(),this._canUndoList=[],this._canRedoList=[],this._cursorWrap.innerHTML=""},r.prototype.clearBackground=function(){this.setCanvasBGColor("#ffffff"),this.setCanvasBGImage("")},r.prototype._initCurrentShape=function(e,i){var r=this,n={};if(this._startPosition=[e,i],this._toolType===t.EBoardToolType.SELECT){var s=new F(this.selectPenId,{props:{x1:e,y1:i,x2:e,y2:i},style:o(o({},p.BOARD_SELECT_STYLE),{strokeStyle:this._selectBoxColor})});this._selectShape=this._createProxySetHandle(s,(function(t,e,i,o){if("props"===e||"position"===e||"style"===e){t[e]=i;var n=r._controlBoxPosition[0],s=r._controlBoxPosition[1],a=r._controlBoxPosition[2],h=r._controlBoxPosition[3];r._selectShapes=[];var c=t.getBoundingRect(),l=[c.x,c.y,c.x+c.width,c.y+c.height];r._displayList.forEach((function(t,e){var i,o,c,d,p,u,_,f,v,E,g=t.getBoundingRect(),y=[g.x,g.y,g.x+g.width,g.y+g.height];if(o=y,c=(i=l)[0],d=i[1],p=i[2],u=i[3],_=o[0],f=o[1],v=o[2],E=o[3],c<=_&&d<=f&&v<=p&&E<=u){var S=t.getBoundingRect();0===r._selectShapes.length&&(n=S.x,s=S.x+S.width,a=S.y,h=S.y+S.height),n=n<S.x?n:S.x,s=s<S.x+S.width?S.x+S.width:s,a=a<S.y?a:S.y,h=h<S.y+S.height?S.y+S.height:h,r._selectShapes.push(t.id)}})),r._controlBoxPosition=[n,a,s,h],r.clearPainter(),r._renderTemporaryCanvas(),r._drawToPainter(t)}}))}else if(this.brushType===t.EBoardToolType.FREE_DRAW){(l=[]).push(h([],a(this._startPosition))),n={points:l};var c=new W(this.brushId,{props:n,style:{lineWidth:this._brushThin*this.options.scale/100,strokeStyle:this._brushColor}});this._currentShape=c}else if(this._toolType===t.EBoardToolType.ARROW){var l=h(h([],a(this._startPosition)),a(this._startPosition));n={points:J(l,2.5*this._brushThin)};var d=new P(this.brushId,{props:n,style:{lineWidth:this._brushThin*this.options.scale/100,strokeStyle:this._brushColor}});this._currentShape=d}else if(this._toolType===t.EBoardToolType.LINE){n={x:this._startPosition[0],y:this._startPosition[1],x1:this._startPosition[0],y1:this._startPosition[1]};var u=new H(this.brushId,{props:n,style:{lineWidth:this._brushThin*this.options.scale/100,strokeStyle:this._brushColor}});this._currentShape=u}else if(this._toolType===t.EBoardToolType.RECT){n={x1:e,y1:i,x2:e,y2:i};var _=new F(this.brushId,{props:n,style:{lineWidth:this._brushThin*this.options.scale/100,strokeStyle:this._brushColor}});this._currentShape=_}else if(this._toolType===t.EBoardToolType.ELLIPSE){n={cx:this._startPosition[0],cy:this._startPosition[1],xr:0,yr:0};var f=new k(this.brushId,{props:n,style:{lineWidth:this._brushThin*this.options.scale/100,strokeStyle:this._brushColor}});this._currentShape=f}this._currentShape&&this._toolType!==t.EBoardToolType.SELECT&&this._temporaryList.set(this._currentShape.id,this._currentShape)},r.prototype.handleMouseDown=function(e){if(this._toolType!==t.EBoardToolType.NONE&&this._enabled){var i=0,o=0;if(e instanceof MouseEvent)i=e.offsetX,o=e.offsetY;else if(e.type.includes("touch")){var r=this._canvas.getBoundingClientRect();i=e.touches[0].clientX-r.left,o=e.touches[0].clientY-r.top}var n=Y(Math.floor(i),1),s=Y(Math.floor(o),1);if(this._toolType===t.EBoardToolType.LASER_POINTER){if(!this._laserPointer&&e.type.includes("touch")&&"touchstart"===e.type||e instanceof MouseEvent&&"mouseenter"===e.type){var a=new G(this.uid+"LaserPointer",{props:{cx:n,cy:s,r:10}});e.type.includes("touch")&&(a.touchId=e.touches[0].identifier),this._laserPointer=a,this._laserPointer.buildElement(this._cursorWrap);var h={pId:a.id,width:this.width,height:this.height,shape:a.type,props:a.props,style:a.style,position:a.position,lts:Date.now()},c={bId:this.id,action:f.ADD_SHAPE,data:h};this.emit("reportContent",c)}}else if(this._toolType===t.EBoardToolType.ERASER||this._toolType===t.EBoardToolType.TEXT)(e.type.includes("touch")&&"touchstart"===e.type||e instanceof MouseEvent&&"mousedown"===e.type&&0===e.button)&&(this._toolType===t.EBoardToolType.ERASER?this._eraserShape(n,s):this._toolType===t.EBoardToolType.TEXT&&(e.preventDefault(),e.stopPropagation(),this._textInput?(this._textInput.blur(),this._textInput=null):this._createTextInputAndHandleChange(n,s)));else if(this._toolType!==t.EBoardToolType.SELECT){if(e instanceof MouseEvent&&"mouseenter"===e.type)return;(e.type.includes("touch")&&"touchstart"===e.type||e instanceof MouseEvent&&"mousedown"===e.type&&e.buttons%2!=0)&&(this._startPosition=[n,s],!this._currentShape&&this._initCurrentShape(n,s))}}},r.prototype.handleMouseMove=function(e){var i,r,n,s,c,l,d,p,u,_,v,E,g,y;if(this._enabled&&this._toolType!==t.EBoardToolType.NONE){var S=0,m=0;if(e instanceof MouseEvent)S=e.offsetX,m=e.offsetY;else if(e.type.includes("touch")){var T=this._canvas.getBoundingClientRect();S=e.touches[0].clientX-T.left,m=e.touches[0].clientY-T.top}var A=Y(Math.floor(S),1),b=Y(Math.floor(m),1),I=[A,b];if(this._toolType===t.EBoardToolType.LASER_POINTER){if(this._laserPointer instanceof G&&(e.type.includes("touch")&&"touchmove"===e.type||e instanceof MouseEvent&&"mousemove"===e.type)){0===this._latestMovePosition.length&&(this._latestMovePosition=[A,b]);var C=A-this._latestMovePosition[0],D=b-this._latestMovePosition[1];this._latestMovePosition=[A,b],this._laserPointer.setPosition(this._laserPointer.position[0]+C,this._laserPointer.position[1]+D);var w={pIds:[this._laserPointer.id],offset:[this._laserPointer.position[0]/this.width,this._laserPointer.position[1]/this.height]},B={bId:this.id,action:f.MOVE_SHAPE,data:w};this._needUpdateShapeData=B}}else if(this._toolType===t.EBoardToolType.SELECT&&(e.type.includes("touch")&&"touchmove"===e.type||e instanceof MouseEvent&&"mousemove"===e.type&&e.buttons%2!=0))!this._selectShape&&this._initCurrentShape(A,b),this._selectShape.attr("props",{x2:I[0],y2:I[1]});else if(this._toolType!==t.EBoardToolType.ERASER&&this._toolType!==t.EBoardToolType.TEXT&&this._currentShape){var R=this._currentShape.style,O=R.strokeStyle;R.fillStyle;var L={};O&&(L.strokeStyle=this._brushColor),null===(i=this._currentShape)||void 0===i||i.attr("style",L);var x={pId:this._currentShape.id,shape:this._currentShape.type,style:this._currentShape.style,props:this._needUpdateShapeData?null===(n=null===(r=this._needUpdateShapeData)||void 0===r?void 0:r.data)||void 0===n?void 0:n.props:{},width:this.width,height:this.height,position:[0,0],lts:Date.now()};B={bId:this.id,action:f.ADD_SHAPE,data:x};if(this._toolType===t.EBoardToolType.FREE_DRAW){var N=(null===(s=this._currentShape)||void 0===s?void 0:s.props.points)||[],P=(null===(c=null==x?void 0:x.props)||void 0===c?void 0:c.points)||[];if(I[0]!==N[N.length-1][0]||I[1]!==N[N.length-1][1]){N.push(h([],a(I))),P.push([I[0],I[1]]);var M={points:N};null===(l=this._currentShape)||void 0===l||l.attr("props",M),this._renderTemporaryCanvas(),x.props={points:P},B.data=x,this._needUpdateShapeData=B}}else if(this._toolType===t.EBoardToolType.LINE){M=o(o({},null===(d=this._currentShape)||void 0===d?void 0:d.props),{x1:I[0],y1:I[1]});x.props=M,null===(p=this._currentShape)||void 0===p||p.attr("props",M),this._renderTemporaryCanvas(),B.data=x,this._needUpdateShapeData=B}else if(this._toolType===t.EBoardToolType.ARROW){N=h(h([],a(this._startPosition)),a(I));var k=J(N,2.5*this._brushThin);M=o(o({},null===(u=this._currentShape)||void 0===u?void 0:u.props),{points:k});x.props=M,null===(_=this._currentShape)||void 0===_||_.attr("props",M),this._renderTemporaryCanvas(),B.data=x,this._needUpdateShapeData=B}else if(this._toolType===t.EBoardToolType.ELLIPSE){var W=function(t){var e=a(t,4),i=e[0],o=e[1],r=e[2],n=e[3],s=Math.abs(r-i)/2,h=Math.abs(n-o)/2;return[i<r?i+s:r+s,o<n?o+h:n+h,s,h]}(N=h(h([],a(this._startPosition)),a(I)));M=o(o({},null===(v=this._currentShape)||void 0===v?void 0:v.props),{cx:Y(W[0],1),cy:Y(W[1],1),xr:Y(W[2],1),yr:Y(W[3],1)});x.props=M,null===(E=this._currentShape)||void 0===E||E.attr("props",M),this._renderTemporaryCanvas(),B.data=x,this._needUpdateShapeData=B}else if(this._toolType===t.EBoardToolType.RECT){M=o(o({},null===(g=this._currentShape)||void 0===g?void 0:g.props),{x2:I[0],y2:I[1]});x.props=M,null===(y=this._currentShape)||void 0===y||y.attr("props",M),this._renderTemporaryCanvas(),B.data=x,this._needUpdateShapeData=B}}}},r.prototype.handleMouseUp=function(e){var i=this;if(this._enabled&&this._toolType!==t.EBoardToolType.NONE){var o=0,r=0;if(e instanceof MouseEvent)o=e.offsetX,r=e.offsetY;else if(e.type.includes("touch")){var n=this._canvas.getBoundingClientRect();o=e.changedTouches[0].clientX-n.left,r=e.changedTouches[0].clientY-n.top}var s=Y(Math.floor(o),1),a=Y(Math.floor(r),1);if(this._endPosition=[s,a],this._toolType!==t.EBoardToolType.LASER_POINTER)if(this._toolType===t.EBoardToolType.SELECT&&this._selectShape){if(Math.abs(this._endPosition[0]-this._startPosition[0])<=1&&Math.abs(this._endPosition[1]-this._startPosition[1])<=1){var h=[];if(this._displayList.forEach((function(t){t.type===_.TEXT?t.isPointInPath(o,r)&&(h=[t]):i._isPointInShape(o,r,t)&&(h=[t])})),h.length>0){this._selectShapes=[h[0].id];var c=h[0].getBoundingRect(),l=c.x,d=c.y,p=c.x+c.width,u=c.y+c.height;this.setControlBoxSize([l,d,p,u]),this.showControlWrap()}}else this.clearPainter(),this._selectShapes.length>0&&(this.showControlWrap(),this.setControlBoxSize(this._controlBoxPosition));this._selectShape=null}else this._toolType!==t.EBoardToolType.ERASER&&this._toolType!==t.EBoardToolType.TEXT&&(this._currentShape&&e instanceof MouseEvent&&"mouseup"===e.type&&0===e.button||e instanceof MouseEvent&&"mouseout"===e.type||e.type.includes("touch")&&"touchend"===e.type)&&(this._currentShape&&(this._toolType===t.EBoardToolType.FREE_DRAW?this._currentShape.props.points.length>1?(this._canUndoList.push({type:f.ADD_SHAPE,shapes:[this._currentShape]}),this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null):this.removeElement(this._currentShape.id):(this._canUndoList.push({type:f.ADD_SHAPE,shapes:[this._currentShape]}),this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null),this._displayList.set(this._currentShape.id,this._currentShape),this.drawToCachePainter(this._currentShape),this._temporaryList.delete(this._currentShape.id),this._renderTemporaryCanvas()),this._currentShape=null);else if(this._laserPointer&&e.type.includes("touch")&&("touchend"===e.type||"touchcancel"===e.type)||e instanceof MouseEvent&&"mouseout"===e.type){if(e.type.includes("touch")&&("touchend"===e.type||"touchcancel"===e.type)){var v=e,E=this._laserPointer.touchId,g=!1;for(var y in v.changedTouches){if(v.changedTouches[y].identifier===E){g=!0;break}}if(!g)return}this._needUpdateShapeData=null,this.emit("reportContent",{bId:this.id,action:f.DELETE_SHAPE,data:{pIds:[this._laserPointer.id]}}),this._laserPointer.dispose(),this._laserPointer=null,this._latestMovePosition=[]}}},r.prototype.handleControlBoxMouseDown=function(t){if(t.type.includes("touch")&&"touchstart"===t.type||t instanceof MouseEvent&&"mousedown"===t.type){var e=0,i=0;t instanceof MouseEvent?(e=t.pageX,i=t.pageY):t.type.includes("touch")&&(e=t.touches[0].pageX,i=t.touches[0].pageY),t.target===this._controlBox?(this.selectStartPosition.length<=0&&(this.selectStartPosition=[e,i],this.selectLatestMovePosition=[e,i]),t.stopPropagation(),t.preventDefault()):t.target===this._controlWrap&&this._selectShapes.length>0&&(this.hideControlWrap(),this._selectShapes=[])}},r.prototype.handleControlBoxMouseMove=function(t){var e=this,i=0,o=0;if(t instanceof MouseEvent?(i=t.pageX,o=t.pageY):t.type.includes("touch")&&(i=t.touches[0].pageX,o=t.touches[0].pageY),(t.type.includes("touch")&&"touchmove"===t.type||t instanceof MouseEvent&&"mousemove"===t.type&&t.buttons%2!=0)&&this.selectStartPosition.length>0){var r=i-this.selectLatestMovePosition[0],n=o-this.selectLatestMovePosition[1];e._controlBoxPosition[0]+=r,e._controlBoxPosition[1]+=n,e._controlBoxPosition[2]+=r,e._controlBoxPosition[3]+=n,e._controlBox.style.pointerEvents="none",e.setControlBoxPosition(e._controlBoxPosition),this.moveElement(e._selectShapes,[r,n]),this.selectLatestMovePosition=[i,o]}},r.prototype.handleControlBoxMouseUp=function(t){var e=this;if((t.type.includes("touch")||"mouseup"===t.type||t instanceof MouseEvent&&"mouseout"===t.type&&t.target===this._controlWrap&&t.buttons%2!=0)&&this.selectStartPosition.length>0){if(Math.abs(this.selectLatestMovePosition[0]-this.selectStartPosition[0])<=1&&Math.abs(this.selectLatestMovePosition[1]-this.selectStartPosition[1])<=1);else{var i=this.selectLatestMovePosition[0]-this.selectStartPosition[0],o=this.selectLatestMovePosition[1]-this.selectStartPosition[1],r={bId:this.id,action:f.MOVE_SHAPE,data:{pIds:this._selectShapes,offset:[i/this.width,o/this.height]}},n=this._selectShapes.map((function(t){return e._displayList.get(t)}));this._canUndoList.push({type:f.MOVE_SHAPE,shapes:n,offset:[i/this.width,o/this.height]}),this.emit("reportContent",r)}this.selectStartPosition=[],this.selectLatestMovePosition=[],this._controlBox.style.pointerEvents="all"}},r.prototype.releaseMouse=function(){switch(this._toolType){case t.EBoardToolType.ARROW:case t.EBoardToolType.ELLIPSE:case t.EBoardToolType.ERASER:case t.EBoardToolType.FREE_DRAW:case t.EBoardToolType.LINE:case t.EBoardToolType.RECT:case t.EBoardToolType.TEXT:this._currentShape&&(this._currentShape=null,this._temporaryList.clear());break;case t.EBoardToolType.LASER_POINTER:this._laserPointer&&(this._laserPointer=null,this._latestMovePosition=[]);break;case t.EBoardToolType.SELECT:this._selectShape&&(this._selectShape=null,this._selectShapes=[])}this._needUpdateShapeData&&(this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null)},r.prototype.clearPainter=function(){this._canvasCtx.clearRect(0,0,this.width,this.height)},r.prototype.clearCachePainter=function(){this._cacheCanvasCtx.clearRect(0,0,this.width,this.height)},r.prototype.clearText=function(){this._textBox.innerHTML=""},r.prototype.drawCacheToMain=function(){this._canvasCtx.drawImage(this._cacheCanvas,0,0)},r.prototype._renderTemporaryCanvas=function(){var t=this;this.clearPainter(),this._temporaryList.forEach((function(e){t._drawToPainter(e)}))},r.prototype._drawToPainter=function(t){t.buildPath(this._canvasCtx,t)},r.prototype.drawToCachePainter=function(t){t.buildPath(this._cacheCanvasCtx,t)},r.prototype._handleShapeAttr=function(t,e){var i=this;return this._createProxySetHandle(t,(function(t,o,r,n){e&&e(t,o,r,n),"props"!==o&&"style"!==o||(t[o]=r,i.clearPainter(),t instanceof G?t.setPosition(t.position[0],t.position[1]):i._drawToPainter(t))}))},r.prototype._createProxySetHandle=function(t,e){return new Proxy(t,{set:function(t,i,o,r){return e(t,i,o,r),Reflect.set(t,i,o,r)}})},r.prototype._setBrushCursor=function(e){this._toolType=e;var i="";switch(e){case t.EBoardToolType.SELECT:case t.EBoardToolType.ARROW:case t.EBoardToolType.LINE:case t.EBoardToolType.RECT:case t.EBoardToolType.ELLIPSE:i="crosshair";break;case t.EBoardToolType.FREE_DRAW:var o=decodeURIComponent("data:image/svg+xml,%3c%3fxml version='1.0' encoding='UTF-8'%3f%3e%3csvg width='32px' height='32px' viewBox='0 0 32 32' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e %3ctitle%3efree-hand%3c/title%3e %3cdefs%3e %3cpath d='M1427.058%2c345.43405 C1427.254%2c345.23905 1427.571%2c345.23905 1427.766%2c345.43405 L1427.766%2c345.43405 L1433.374%2c351.04305 C1433.472%2c351.14005 1433.521%2c351.26805 1433.521%2c351.39605 C1433.521%2c351.52505 1433.472%2c351.65305 1433.374%2c351.75005 L1433.374%2c351.75005 L1423.463%2c361.72705 C1423.369%2c361.82105 1423.242%2c361.87405 1423.109%2c361.87405 L1423.109%2c361.87405 L1417.501%2c361.87405 C1417.224%2c361.87405 1417%2c361.65005 1417%2c361.37305 L1417%2c361.37305 L1417%2c355.76505 C1417%2c355.63205 1417.053%2c355.50505 1417.147%2c355.41105 L1417.147%2c355.41105 Z M1430.546%2c341.94725 C1431.808%2c340.68425 1433.855%2c340.68425 1435.118%2c341.94725 L1435.118%2c341.94725 L1436.862%2c343.69125 C1437.493%2c344.32225 1437.809%2c345.14925 1437.809%2c345.97725 C1437.809%2c346.80425 1437.493%2c347.63225 1436.862%2c348.26325 L1436.862%2c348.26325 L1435.815%2c349.31025 C1435.618%2c349.50725 1435.299%2c349.50725 1435.102%2c349.31025 L1435.102%2c349.31025 L1429.498%2c343.70625 C1429.4%2c343.60825 1429.351%2c343.47925 1429.351%2c343.35025 C1429.351%2c343.22125 1429.4%2c343.09225 1429.498%2c342.99425 L1429.498%2c342.99425 Z' id='path-1'%3e%3c/path%3e %3c/defs%3e %3cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'%3e %3cg transform='translate(-1416.000000%2c -331.000000)'%3e %3cuse stroke='%235A5A67' stroke-width='2' fill='%235A5A67' fill-rule='evenodd' xlink:href='%23path-1'%3e%3c/use%3e %3cuse stroke='white' stroke-width='1' xlink:href='%23path-1'%3e%3c/use%3e %3c/g%3e %3c/g%3e%3c/svg%3e");i='url("data:image/svg+xml;base64,'+btoa(o.split("data:image/svg+xml,")[1])+'") 0 36, crosshair';break;case t.EBoardToolType.ERASER:var r=decodeURIComponent("data:image/svg+xml,%3c%3fxml version='1.0' encoding='UTF-8'%3f%3e%3csvg width='32px' height='32px' viewBox='0 0 32 32' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e %3ctitle%3eeraser%3c/title%3e %3cdefs%3e %3cpath d='M1542.63604%2c401.636491 C1542.64212%2c401.642264 1542.64811%2c401.648114 1542.65404%2c401.654038 L1549.74863%2c408.748632 C1550.12256%2c409.122557 1550.14072%2c409.722967 1549.79008%2c410.11881 L1542.80885%2c417.999142 L1532.31285%2c417.999142 L1529.38519%2c415.711238 C1528.95%2c415.371189 1528.87288%2c414.742739 1529.21293%2c414.307554 C1529.23283%2c414.282078 1529.25396%2c414.257582 1529.27624%2c414.234152 L1541.22228%2c401.672031 C1541.60286%2c401.271816 1542.23583%2c401.255904 1542.63604%2c401.636491 Z' id='path-1'%3e%3c/path%3e %3crect id='path-2' x='1539.73654' y='400.606602' width='14' height='8' rx='1'%3e%3c/rect%3e %3c/defs%3e %3cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'%3e %3cg transform='translate(-1528.000000%2c -387.000000)'%3e %3cg%3e %3cuse stroke='%235A5A67' stroke-width='2' fill='%235A5A67' fill-rule='evenodd' xlink:href='%23path-1'%3e%3c/use%3e %3cuse stroke='white' stroke-width='1' xlink:href='%23path-1'%3e%3c/use%3e %3c/g%3e %3cg transform='translate(1546.736544%2c 404.606602) rotate(-315.000000) translate(-1546.736544%2c -404.606602) '%3e %3cuse stroke='%235A5A67' stroke-width='2' fill='white' fill-rule='evenodd' xlink:href='%23path-2'%3e%3c/use%3e %3cuse stroke='white' stroke-width='1' xlink:href='%23path-2'%3e%3c/use%3e %3c/g%3e %3c/g%3e %3c/g%3e%3c/svg%3e");i='url("data:image/svg+xml;base64,'+btoa(r.split("data:image/svg+xml,")[1])+'") 3 36, crosshair';break;case t.EBoardToolType.TEXT:i="text";break;case t.EBoardToolType.LASER_POINTER:i="none";break;default:i="default"}this._canvas.style.cursor=i},r.prototype._isPointInShape=function(t,e,i){var o=U({kind:"canvas",props:{width:this.width,height:this.height},style:{}}).el.getContext("2d");return i.buildPath(o,i),0!==o.getImageData(t,e,1,1).data[3]},r.prototype._eraserShape=function(t,e){var i,o=this;if(this._displayList.forEach((function(r){r instanceof z?r.isPointInPath(t,e)&&(i=r):o._isPointInShape(t,e,r)&&(i=r)})),i){this._displayList.delete(i.id);var r={bId:this.id,action:f.DELETE_SHAPE,data:{pIds:[i.id]}};this.emit("reportContent",r),this._canUndoList.push({type:f.DELETE_SHAPE,shapes:[i]}),this.clearCachePainter(),this._displayList.forEach((function(t){o.drawToCachePainter(t)}))}},r.prototype._addInputElement=function(t,e,i){var r=(this.boxWidth-this.width)/2,n=(this.boxHeight-this.height)/2,s=U({kind:"textarea",props:o({},p.TEXT_INPUT_ELEMENT_OPTIONS.props),style:o(o({},p.TEXT_INPUT_ELEMENT_OPTIONS.style),{top:i+n+"px",left:e+r+"px","max-width":this.boxWidth-e+"px","max-height":this.boxHeight-i+"px","white-space":"pre-wrap","box-sizing":"content-box",outline:"none",resize:"none","word-break":"break-all",color:this._textColor,"font-style":this._textStyle,"font-size":this._textSize+"px","font-weight":this._textWeight,"line-height":this._textSize+"px","min-width":this._textSize+"px","min-height":this._textSize+"px"})}).el;return this.createTextInput(s),s},r.prototype._createTextInputAndHandleChange=function(t,e){var i=this,o={},r=this.brushId,n=this._addInputElement(r,t,e);this._textInput=n;var s=this.boxWidth-t;n.onfocus=function(t){t.target.style.border="1px dashed rgba(167, 156, 156,1)"},n.focus(),requestAnimationFrame((function(){return n.focus()})),n.oninput=function(t){var e=t.target.value,o=K(e,{fontSize:i._textSize,fontStyle:i._textStyle,fontWeight:i._textWeight,lineHeight:i._textSize,fontFamily:"customFontFamily, sans-serif, serif, monospace"},s),r=o.width,n=o.height;o.list,t.target.style.width=r+2+"px",t.target.style.height=n+2+"px"},n.onblur=function(r){var s=n.value;if(s){o={text:s,fontSize:i._textSize,lineHeight:i._textSize,x:t,y:e,maxWidth:i.boxWidth-t,maxHeight:i.boxHeight-e};var a=new z(i.brushId,{props:o,style:{textFill:i._textColor,textStyle:i._textStyle,textWeight:i._textWeight}});i.drawToCachePainter(a);var h=i._handleShapeAttr(a);i._displayList.set(a.id,h),i._canUndoList.push({type:f.ADD_SHAPE,shapes:[a]});var c={bId:i.id,action:f.ADD_SHAPE,data:{pId:a.id,width:i.width,height:i.height,shape:a.type,props:a.props,style:a.style,position:a.position,lts:Date.now()}};i.emit("reportContent",c)}n.remove(),i._textInput=null}},r}(rt),ht=function(){this.type=0,this.fId="#DEFAULT",this.url="",this.title="DEFAULT",this.currentPageIndex=1,this.totalPageCount=1,this.boardList=[],this.width=1920,this.height=1080},ct=function(t){this.bId="",this.scale=100,this.ratio="",this.color="#ffffff",this.image="",this.imageFillMode="contain",this.url="",this.pList=new Map,this.canUndoList=[],this.canRedoList=[],this.bId=t},lt=function(){function t(t){if(this._url="",this._wss=!0,this._port=443,this._timeout=6e4,"[object Object]"===Object.prototype.toString.call(t)){var e=t.url,i=t.wss,o=t.port,r=t.timeout;"string"==typeof e&&(this._url=e),"boolean"==typeof i&&(this._wss=i,this._port=i?443:80),"number"==typeof o&&(this._port=o),"number"==typeof r&&(this._timeout=r)}}return t.prototype.setRequestUrl=function(t){if("[object Object]"===Object.prototype.toString.call(t)){var e=t.url,i=t.wss,o=t.port;"string"==typeof e&&(this._url=e),"boolean"==typeof i&&(this._wss=i,this._port=i?443:80),"number"==typeof o&&(this._port=o)}},t.prototype.request=function(t,e,i){return this._sendUrlRequest(t,e,i)},t.prototype.post=function(t,e){return this.request(t,"POST",e)},t.prototype.get=function(t,e){return this.request(t,"GET",e)},t.prototype._sendUrlRequest=function(t,e,i,o){var r=this;return void 0===o&&(o=!0),new Promise((function(n,s){if(""!==r._url){var a=r._url;t&&(a=r._url+t);var h=new XMLHttpRequest;h.timeout=6e4;var c=function(){200===h.status?n(JSON.parse(h.responseText)):s(new it(S))};o&&(h.onreadystatechange=function(t){4===h.readyState&&c()}),h.open(e,a,o),h.onerror=function(t){s(new it(m))},h.ontimeout=function(){s(new it(y))},h.send(JSON.stringify(i)),o||c()}else s("NO_REQUEST_URL")}))},t}(),dt=function(){function t(){this._urls=[],this._urlSuffix="/arapi/v1?action=",this._appid="",this._sessionId="",this._urls=[p.GATEWAY_ADDRESS],this._urlSuffix="/arapi/v1?action="}return t.prototype.joinGateway=function(t){var e=this;void 0===t&&(t={});var i=this;return new Promise((function(s,a){var h=i._urlSuffix.concat("wb_gateway"),c=function(){return r(e,void 0,void 0,(function(){var e,r,l,d,u,_;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,Promise.race(this._urls.map((function(e){return new lt({url:e,timeout:p.GATEWAY_CONNECT_TIMEOUT}).post(h,o({},t))})))];case 1:if(e=n.sent())if(0===(r=e.code))l=e.sessionid,d=t.appId,i._sessionId=l,i._appid=d,s(e);else if(-1===r)setTimeout((function(){c()}),p.GATEWAY_CONNECT_TIMEOUT);else{if(-4===r||-7===r)throw new it(T,"MISSING_PARAMETER");if(13===r)throw new it(A,"DEVELOPER_INVALID");if(14===r)throw new it(b,"UID_BANNED");if(15===r)throw new it(I,"IP_BANNED");if(16===r)throw new it(C,"CHANNEL_BANNED");if(101===r)throw new it(D,"APPID_INVALID");if(102===r)throw new it(w,"SERVER_NOT_OPEN");if(109===r)throw new it(B,"TOKEN_EXPIRED You must request a new token from your server and call join to use the new token to join the channel");if(110===r)throw new it(R,"TOKEN_INVALID make sure token is right and try angain please");setTimeout((function(){c()}),p.GATEWAY_CONNECT_TIMEOUT)}return[3,3];case 2:return u=n.sent(),"NETWORK_ERROR"===(_=u).code||"NETWORK_TIMEOUT"===_.code||"NETWORK_RESPONSE_ERROR"===_.code?(setTimeout((function(){c()}),p.GATEWAY_CONNECT_TIMEOUT),[2]):(a(_),[3,3]);case 3:return[2]}}))}))};c()}))},t}();t.EConnectionState=void 0,(Z=t.EConnectionState||(t.EConnectionState={}))[Z.DISCONNECTED=0]="DISCONNECTED",Z[Z.CONNECTING=1]="CONNECTING",Z[Z.RECONNECTING=2]="RECONNECTING",Z[Z.CONNECTED=3]="CONNECTED",Z[Z.DISCONNECTING=4]="DISCONNECTING";var pt=function(e){function o(i){var o=e.call(this)||this;if(o._websocket=null,o._url="",o._wss=!0,o._port=443,o.revState=t.EConnectionState.DISCONNECTED,o.curState=t.EConnectionState.DISCONNECTED,o.onclose=function(){},o.onerror=function(){},o.onmessage=function(){},i&&"[object Object]"===Object.prototype.toString.call(i)){var r=i.url,n=i.wss,s=i.port;r&&(o._url=r),"boolean"==typeof n&&(o._wss=n),s&&(o._port=s)}return o}return i(o,e),Object.defineProperty(o.prototype,"connectState",{get:function(){return this._websocket?this._websocket.readyState:WebSocket.CLOSED},enumerable:!1,configurable:!0}),o.prototype.open=function(t){var e=this;return new Promise((function(i,o){if(t&&"[object Object]"===Object.prototype.toString.call(t)){var r=t.url,n=t.wss,s=t.port;r&&(e._url=r),"boolean"==typeof n&&(e._wss=n),s&&(e._port=s)}var a=(e._wss?"wss":"ws")+"://"+e._url+":"+e._port;$.debug("[ws-client] websocket opened: "+a),e._websocket=new WebSocket(a),e._websocket.onopen=function(){$.debug("Signaling channel opened. "+a),e._websocket.onerror=function(t){$.debug("Signaling channel error."),e.onerror(t)},e._websocket.onclose=function(t){$.debug(e._url+" server closed with code: "+t.code+" reason: "+t.reason),e.onclose(t),e._websocket=null},i()},e._websocket.onmessage=function(t){e.onmessage(t)},e._websocket.onerror=function(t){o(Error("WebSocket error."))}}))},o.prototype.close=function(){this._websocket&&(this._websocket.close(),this._websocket=null)},o.prototype.send=function(t){"object"==typeof t?this._websocket&&1===this._websocket.readyState&&this._websocket.send(JSON.stringify(t)):$.error("signal channel msg must be object.")},o.prototype.addMessageEventListener=function(t,e){if(this._websocket)return this._websocket.addEventListener("message",t,e)},o.prototype.removeMessageEventListener=function(t,e){if(this._websocket)return this._websocket.removeEventListener("message",t,e)},o.prototype.clear=function(){this.close(),this.onerror=function(){},this.onclose=function(){},this.onmessage=function(){},this.addMessageEventListener=function(){},this.removeMessageEventListener=function(){}},o}(et),ut=function(t){return t.then((function(t){return[null,t]})).catch((function(t){return[t]}))},_t=function(e){function o(t){var i=e.call(this)||this;i._cmdEncrypt=!1,i._appId="",i._serverIsWss=!0,i._serverUrl="",i._serverPort=0,i._channel=null,i._userId=null,i._connectTimeout=0,i._keepAliveTimeout=0,i._keepALiveInterval=0,i._keepALiveIntervalTime=1e4,i.handleMediaServerEvents=function(){};var o=i;return t&&t.appId&&(o._appId=t.appId),i}return i(o,e),o.prototype.send=function(t){e.prototype.send.call(this,t)},o.prototype.init=function(t){var e=this,i=t.appId,o=t.isWss,r=t.url,n=t.port;i&&(e._appId=i),"boolean"==typeof o&&(e._serverIsWss=o),r&&(e._serverUrl=r),n&&(e._serverPort=n)},o.prototype.setAppInfo=function(t){var e=t.appId;this._appId=e},o.prototype.configServer=function(t,e,i){var o=this;o._serverIsWss=t,o._serverUrl=e,o._serverPort=i},o.prototype.connectServer=function(e,i,o){var s=this,h=this;return new Promise((function(c,l){return r(s,void 0,void 0,(function(){var r,s,d,p;return n(this,(function(n){switch(n.label){case 0:return h._emitConnectionState(t.EConnectionState.CONNECTING),h._setConnectTimeout(),[4,ut(h.open({url:h._serverUrl,wss:h._serverIsWss,port:h._serverPort}))];case 1:return r=a.apply(void 0,[n.sent(),2]),(s=r[0])?(h._clearConnectTimeout(),l(s),[3,4]):[3,2];case 2:return h._clearConnectTimeout(),h._emitConnectionState(t.EConnectionState.CONNECTED),this._channel=e,this._userId=i,[4,ut(this.doInit({appId:h._appId,chanId:e,uId:i,accessToken:o}))];case 3:if(d=a.apply(void 0,[n.sent(),2]),p=d[0])return h._clearConnectTimeout(),l(p),[2];c(),h.onmessage=function(t){var e=t.data,i=JSON.parse(e),o=i.cmd,r=i.data;if(i.errMsg,i.errCode,"CONNECT"===o);else h.handleMediaServerEvents&&h.handleMediaServerEvents(o,r)},h.onerror=function(t){$.error("board server handle some error ",t)},h.onclose=function(e){var i=e.code,o=e.reason;switch($.info("board serve disconnected...",i),h._clearConnectTimeout(),h._clearKeepALiveTimeout(),i){case 1e3:case 1005:h._emitConnectionState(t.EConnectionState.DISCONNECTED,"LEAVE");break;case 3001:h._emitConnectionState(t.EConnectionState.RECONNECTING,"NETWORK_ERROR");break;default:$.debug("bNode serve disconnected with code "+i+", reason "+o),h.curState!==t.EConnectionState.RECONNECTING&&h._emitConnectionState(t.EConnectionState.RECONNECTING,"SERVER_ERROR")}h.clear()},c(),n.label=4;case 4:return[2]}}))}))}))},o.prototype.doInit=function(t){var e=this;return new Promise((function(i,o){var r=""+Date.now(),n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.INIT&&r===l&&(e.removeMessageEventListener(n),0===c?i():($.warning("BOARD_SERVER_INIT_FAILED"),o("BOARD_SERVER_INIT_FAILED")))};e.addMessageEventListener(n);var s={cmd:f.INIT,seqId:r,data:t,rts:r};e.send(s)}))},o.prototype.doGetChannelInfo=function(){var t=this;return new Promise((function(e,i){var o=""+Date.now(),r=function(i){var n=i.data,s=JSON.parse(n),a=s.cmd;s.data,s.errMsg,s.errCode;var h=s.seqId;a===f.CHAN_DATA&&o===h&&(t.removeMessageEventListener(r),e())};t.addMessageEventListener(r);var n={cmd:f.CHAN_DATA,seqId:o,rts:o};t.send(n)}))},o.prototype.doAddFile=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.ADD_FILE&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("ADD_FILE_FAILED"),r("ADD_FILE_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.ADD_FILE,seqId:e,rts:e,data:t};i.send(s)}))},o.prototype.doAddBoard=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.ADD_BOARD&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("ADD_BOARD_FAILED"),r("ADD_BOARD_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.ADD_BOARD,seqId:e,data:t,rts:e};i.send(s)}))},o.prototype.doDeleteBoard=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.DELETE_BOARD&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("DELETE_BOARD_FAILED"),r("DELETE_BOARD_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.DELETE_BOARD,seqId:e,data:t,rts:e};i.send(s)}))},o.prototype.doSwitchBoard=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.SWITCH_BOARD&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("SWITCH_BOARD_FAILED"),r("SWITCH_BOARD_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.SWITCH_BOARD,seqId:e,data:t,rts:e};i.send(s)}))},o.prototype.doResetBoard=function(t){var e=this;return new Promise((function(i,o){var r=function(n){var s=n.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.RESET_BOARD&&t===l&&(e.removeMessageEventListener(r),0===c?i():($.warning("RESET_BOARD_FAILED"),o("RESET_BOARD_FAILED")))};e.addMessageEventListener(r);var n={cmd:f.RESET_BOARD,seqId:t,rts:t};e.send(n)}))},o.prototype.doClearBoard=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.CLEAR_BOARD&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("CLEAR_BOARD_FAILED"),r("CLEAR_BOARD_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.CLEAR_BOARD,seqId:e,data:t,rts:e};i.send(s)}))},o.prototype.doSetBoardRatio=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.RATIO_BOARD&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("BOARD_RATIO_FAILED"),r("BOARD_RATIO_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.RATIO_BOARD,seqId:e,rts:e,data:t};i.send(s)}))},o.prototype.doScaleBoard=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.SCALE_BOARD&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("SCALE_BOARD_FAILED"),r("SCALE_BOARD_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.SCALE_BOARD,seqId:e,rts:e,data:t};i.send(s)}))},o.prototype.doUpdateBoardBackgroundColor=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.UPDATE_BACKGROUND&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("UPDATE_BACKGROUND_FAILED"),r("UPDATE_BACKGROUND_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.UPDATE_BACKGROUND,seqId:e,rts:e,data:t};i.send(s)}))},o.prototype.doUpdateBoardBackgroundImage=function(t){var e=this;return new Promise((function(i,o){var r=""+Date.now(),n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.UPDATE_BACKGROUND_IMAGE&&r===l&&(e.removeMessageEventListener(n),0===c?i():($.warning("UPDATE_BACKGROUND_IMAGE_FAILED"),o("UPDATE_BACKGROUND_IMAGE_FAILED")))};e.addMessageEventListener(n);var s={cmd:f.UPDATE_BACKGROUND_IMAGE,seqId:r,rts:r,data:t};e.send(s)}))},o.prototype.doAddShape=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.ADD_SHAPE&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("ADD_SHAPE_FAILED"),r("ADD_SHAPE_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.ADD_SHAPE,seqId:e,rts:e,data:t};i.send(s)}))},o.prototype.doMoveShape=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.MOVE_SHAPE&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("MOVE_SHAPE_FAILED"),r("MOVE_SHAPE_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.MOVE_SHAPE,seqId:e,rts:e,data:t};i.send(s)}))},o.prototype.doDeleteShape=function(t,e){var i=this;return new Promise((function(o,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===f.DELETE_SHAPE&&e===l&&(i.removeMessageEventListener(n),0===c?o():($.warning("DELETE_SHAPE_FAILED"),r("DELETE_SHAPE_FAILED")))};i.addMessageEventListener(n);var s={cmd:f.DELETE_SHAPE,seqId:e,rts:e,data:t};i.send(s)}))},o.prototype.disconnectServer=function(e){var i=this;if(i._clearKeepALiveTimeout(),i.clear(),e)switch(e){case"UID_BANNED":case"TOKEN_INVALID":case"FORCE_OFFLINE":i._emitConnectionState(t.EConnectionState.DISCONNECTED,e)}else i._emitConnectionState(t.EConnectionState.DISCONNECTED,"LEAVE")},o.prototype.clearEventEmitter=function(){this.removeAllListeners()},o.prototype._setConnectTimeout=function(){this._clearConnectTimeout()},o.prototype._clearConnectTimeout=function(){this._connectTimeout&&clearTimeout(this._connectTimeout)},o.prototype._clearKeepALiveTimeout=function(){var t=this;t._keepAliveTimeout&&(clearTimeout(t._keepAliveTimeout),t._keepAliveTimeout=0)},o.prototype._emitConnectionState=function(e,i){e===t.EConnectionState.DISCONNECTED&&$.debug("[signal] bNode websocket closed, reason: "+i),this.revState=this.curState,this.curState=e,this.handleMediaServerEvents&&this.handleMediaServerEvents("connection-state-change",{curState:this.curState,revState:this.revState,reason:i})},o}(pt),ft={},vt=function(){return function(){var t,e,i=void 0,o=navigator.userAgent,r=o.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];"Chrome"===r[1]&&null!=(i=o.match(/(OPR(?=\/))\/?(\d+)/i))&&(r=i),"Safari"===r[1]&&null!=(i=o.match(/version\/(\d+)/i))&&(r[2]=i[1]),~o.toLowerCase().indexOf("qqbrowser")&&null!=(i=o.match(/(qqbrowser(?=\/))\/?(\d+)/i))&&(r=i),~o.toLowerCase().indexOf("micromessenger")&&null!=(i=o.match(/(micromessenger(?=\/))\/?(\d+)/i))&&(r=i),~o.toLowerCase().indexOf("edge")&&null!=(i=o.match(/(edge(?=\/))\/?(\d+)/i))&&(r=i),~o.toLowerCase().indexOf("trident")&&null!=(i=/\brv[ :]+(\d+)/g.exec(o)||[])&&(r=[null,"IE",i[1]]);var n=void 0;try{for(var a=s([{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}]),h=a.next();!h.done;h=a.next()){var c=h.value;if(c.r.test(navigator.userAgent)){n=c.s;break}}}catch(e){t={error:e}}finally{try{h&&!h.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}return{name:r[1],version:r[2],os:n}}()},Et=function(){return vt().os};ft.getBrowserInfo=vt,ft.getBrowserOS=Et,ft.isChrome=function(){var t=vt();return t.name&&"Chrome"===t.name},ft.isSafari=function(){var t=vt();return t.name&&"Safari"===t.name},ft.isEdge=function(){var t=vt();return t.name&&"Edge"===t.name},ft.isFireFox=function(){var t=vt();return t.name&&"Firefox"===t.name},ft.isOpera=function(){var t=vt();return t.name&&"OPR"===t.name},ft.isQQBrowser=function(){var t=vt();return t.name&&"QQBrowser"===t.name},ft.isWeChatBrowser=function(){var t=vt();return t.name&&"MicroMessenger"===t.name},ft.isSupportedPC=function(){var t=Et();return"Linux"===t||"Mac OS X"===t||"Mac OS"===t||-1!==t.indexOf("Windows")},ft.isSupportedMobile=function(){var t=Et();return"Android"===t||"iOS"===t},ft.getBrowserVersion=function(){return vt().version},ft.isChromeKernel=function(){return!!navigator.userAgent.match(/chrome\/[\d]./i)},ft.isLegacyChrome=function(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35};var gt,yt=ft.isChrome()&&ft.getBrowserVersion()>=87,St=function(e){function s(t){var i=e.call(this)||this;i._cmdEncrypt=!1,i._appId="",i._serverIsWss=!0,i._serverUrl="",i._serverPort=0,i._userId=null,i._connectTimeout=0,i._keepAliveTimeout=0,i._keepALiveInterval=0,i._keepALiveIntervalTime=1e4,i.handleMediaServerEvents=function(){};var o=i;return t&&t.appId&&(o._appId=t.appId),i}return i(s,e),s.prototype.init=function(t){var e=this,i=t.appId,o=t.isWss,r=t.url,n=t.port;e._appId=i,"boolean"==typeof o&&(e._serverIsWss=o),r&&(e._serverUrl=r),n&&(e._serverPort=n)},s.prototype.setAppInfo=function(t){var e=t.appId;this._appId=e},s.prototype.configServer=function(t,e,i){var o=this;o._serverIsWss=t,o._serverUrl=e,o._serverPort=i},s.prototype.connectServer=function(){var e=this,i=this;return new Promise((function(o,s){return r(e,void 0,void 0,(function(){var e,r,h,c=this;return n(this,(function(n){switch(n.label){case 0:return i._emitConnectionState(t.EConnectionState.CONNECTING),i._setConnectTimeout(),[4,ut(i.open({url:i._serverUrl,wss:i._serverIsWss,port:i._serverPort}))];case 1:return e=a.apply(void 0,[n.sent(),2]),(r=e[0])?(i._clearConnectTimeout(),s(r)):(h=(i._serverIsWss?"wss":"ws")+"://"+i._serverUrl+":"+i._serverPort,$.debug("[ws-client] websocket opened: "+h),i._clearConnectTimeout(),i._emitConnectionState(t.EConnectionState.CONNECTED),i.onmessage=function(t){var e=t.data,o=JSON.parse(e),r=o.Cmd;o.Encrypt;var n=o.Content,s=JSON.parse(n);switch(r){case"KeepAlive":i._clearKeepALiveTimeout();break;case"ReqKeepAlive":c.doKeepAlive();break;case"Login":!yt&&i._startKeepAlive();break;default:i.handleMediaServerEvents&&i.handleMediaServerEvents(r,s)}},i.onerror=function(t){$.error("rtm server handle some error ",t)},i.onclose=function(e){var o=e.code,r=e.reason;switch($.info("rtm serve disconnected...",o),i._clearConnectTimeout(),i._stopKeepAlive(),i._clearKeepALiveTimeout(),o){case 1e3:case 1005:i._emitConnectionState(t.EConnectionState.DISCONNECTED,"LEAVE");break;case 3001:i._emitConnectionState(t.EConnectionState.RECONNECTING,"NETWORK_ERROR");break;default:$.debug("mNode ws serve disconnected with code "+o+", reason "+r),i.curState!==t.EConnectionState.RECONNECTING&&i._emitConnectionState(t.EConnectionState.RECONNECTING,"SERVER_ERROR")}i.clear()},o()),[2]}}))}))}))},s.prototype.doKeepAlive=function(){var e=this,i={Cmd:"KeepAlive"};i.Encrypt=this._cmdEncrypt,i.Content=JSON.stringify({time:Date.now().toString()}),this.send(i),!e._keepAliveTimeout&&(e._keepAliveTimeout=setTimeout((function(){e._stopKeepAlive(),e._clearKeepALiveTimeout(),e.clear(),e._emitConnectionState(t.EConnectionState.RECONNECTING,"KEEP_A_LIVE_TIME_OUT")}),2*e._keepALiveIntervalTime))},s.prototype.doOnline=function(t){var e=this;return new Promise((function(i,r){var n=function(t){var o=t.data,s=JSON.parse(o),a=s.Cmd;s.Encrypt;var h=s.Content,c=JSON.parse(h);if("Login"===a){e.removeMessageEventListener(n);var l=c.Code;if(0===l){var d=c.UserId;e._userId=d,i(d)}else $.error("user online failure, code => ",l),r(l)}};e.addMessageEventListener(n);var s={Cmd:"Login"};s.AppId=e._appId,s.Encrypt=e._cmdEncrypt;var a=o({},t);yt&&(a.SvrKeepAlive=!0),s.Content=JSON.stringify(a),e.send(s)}))},s.prototype.doOffline=function(){var t=this;return new Promise((function(e,i){var o=function(r){var n=r.data,s=JSON.parse(n),a=s.Cmd;s.Encrypt;var h=s.Content,c=JSON.parse(h);if("Logout"===a){t.removeMessageEventListener(o);var l=c.Code;0===l?e(l):i(l)}};t.addMessageEventListener(o);var r={Cmd:"Logout"};r.Encrypt=t._cmdEncrypt,r.Content="",t.send(r)}))},s.prototype.doJoinChannel=function(t){var e=this;return new Promise((function(i,o){var r=function(t){var n=t.data,s=JSON.parse(n),a=s.Cmd;s.Encrypt;var h=s.Content,c=JSON.parse(h);if("JoinChannel"===a){e.removeMessageEventListener(r);var l=c.Code;c.ChanId,0===l?i():o(l)}};e.addMessageEventListener(r);var n={Cmd:"JoinChannel"};n.Encrypt=e._cmdEncrypt,n.Content=JSON.stringify(Object.assign({ChanId:t})),e.send(n)}))},s.prototype.doSendChannelMsg=function(t,e,i,o){void 0===o&&(o=!1);var r=this;return new Promise((function(n,s){var a=X(),h=function(t){var e=t.data,i=JSON.parse(e),o=i.Cmd;i.Encrypt;var c=i.Content,l=JSON.parse(c);if("SendChannelMsg"===o){var d=l.Code;l.ChanId;var p=l.MsgId;a===p&&(r.removeMessageEventListener(h),0===d?n():s(d))}};r.addMessageEventListener(h);var c={Cmd:"SendChannelMsg"};c.Encrypt=r._cmdEncrypt,c.Content=JSON.stringify(Object.assign({ChanId:e,FromUId:r._userId,MsgId:a,MsgType:t,MsgBody:i,HistoryMsg:o,Desc:""})),r.send(c)}))},s.prototype.disconnectServer=function(e){var i=this;if(i._stopKeepAlive(),i._clearKeepALiveTimeout(),i.clear(),e)switch(e){case"UID_BANNED":case"TOKEN_INVALID":case"FORCE_OFFLINE":i._emitConnectionState(t.EConnectionState.DISCONNECTED,e)}else i._emitConnectionState(t.EConnectionState.DISCONNECTED,"LEAVE")},s.prototype.clearEventEmitter=function(){this.removeAllListeners()},s.prototype._setConnectTimeout=function(){var t=this;t._clearConnectTimeout(),t._connectTimeout=window.setTimeout((function(){t._emitConnectionState("DISCONNECTING","NETWORK_ERROR")}),1e4)},s.prototype._startKeepAlive=function(){var t=this;t._stopKeepAlive(),t.doKeepAlive(),t._keepALiveInterval=setInterval((function(){t.doKeepAlive()}),t._keepALiveIntervalTime)},s.prototype._stopKeepAlive=function(){this._keepALiveInterval&&clearInterval(this._keepALiveInterval)},s.prototype._clearConnectTimeout=function(){this._connectTimeout&&clearTimeout(this._connectTimeout)},s.prototype._clearKeepALiveTimeout=function(){var t=this;t._keepAliveTimeout&&(clearTimeout(t._keepAliveTimeout),t._keepAliveTimeout=0)},s.prototype._emitConnectionState=function(e,i){e===t.EConnectionState.DISCONNECTED&&$.debug("[signal] mNode websocket closed, reason: "+i),this.revState=this.curState,this.curState=e,this.handleMediaServerEvents&&this.handleMediaServerEvents("connection-state-change",{curState:this.curState,revState:this.revState,reason:i})},s}(pt),mt=function(){function t(t){this.queues=[],this.maxNumber=1/0,t&&(this.maxNumber=t)}return t.prototype.add=function(t){var e,i,o=[];Array.isArray(t)?o=t:o.push(t);try{for(var r=s(o),n=r.next();!n.done;n=r.next()){var a=n.value;if(this.size+1>this.maxNumber)break;this.queues.push(a)}}catch(t){e={error:t}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}},t.prototype.dequeue=function(){this.queues.length>0&&this.queues.shift()},t.prototype.front=function(){return this.queues.length>0?this.queues[0]:void 0},t.prototype.clear=function(){this.queues=[]},Object.defineProperty(t.prototype,"isEmpty",{get:function(){return 0===this.queues.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this.queues.length},enumerable:!1,configurable:!0}),t}(),Tt=function(e){function o(i,o,r,n){var s=e.call(this)||this;return s._appId="",s._uId="",s._channel="",s._token="",s._rtmSignal=void 0,s._boardSignal=void 0,s._connectState=t.EConnectionState.DISCONNECTED,s._reportBoardDataTimer=void 0,s._reportItem=void 0,s._reportQueue=new mt,s._reportLts=0,s._appId=i,s._uId=o,s._channel=r,s._token=n,s._gateWay=new dt,s}return i(o,e),Object.defineProperty(o.prototype,"connectState",{get:function(){return this._connectState},enumerable:!1,configurable:!0}),o.prototype.connectServer=function(){return r(this,void 0,void 0,(function(){var e,i,o,r,h,c,l,d,u,_,f,E,g,y,S,m,T,A,b,I,C,D,w,B,R,x,N;return n(this,(function(n){switch(n.label){case 0:return this._connectState!==t.EConnectionState.RECONNECTING&&(this._connectState=t.EConnectionState.CONNECTING),e=new URL(p.GATEWAY_ADDRESS),[4,ut(this._gateWay.joinGateway({appId:this._appId,uid:this._uId,cname:this._channel,token:this._token,cType:0,wss:"https:"===e.protocol}))];case 1:if(i=a.apply(void 0,[n.sent(),2]),o=i[0],r=i[1],o)return[2,Promise.reject(o)];if(h=r.code,c=r.accessToken,l=r.addresses,d=r.boardAddr,u=r.sessionid,0!==h)return[3,19];if(this._boardSignal=new _t({appId:this._appId}),this._boardSignal.handleMediaServerEvents=this._handleBoardServerEvents.bind(this),this._rtmSignal=new St({appId:this._appId}),this._rtmSignal.handleMediaServerEvents=this._handleRTMServerEvent.bind(this),!(d.length>0&&l.length>0))return[3,18];_=!1,n.label=2;case 2:n.trys.push([2,7,8,9]),f=s(d),E=f.next(),n.label=3;case 3:return E.done?[3,6]:(A=E.value,b=A.addr,I=A.port,C=A.wss,[4,ut(this._connectBoardServer(C,b,I,c))]);case 4:if(g=a.apply(void 0,[n.sent(),2]),!g[0])return _=!0,[3,6];n.label=5;case 5:return E=f.next(),[3,3];case 6:return[3,9];case 7:return y=n.sent(),B={error:y},[3,9];case 8:try{E&&!E.done&&(R=f.return)&&R.call(f)}finally{if(B)throw B.error}return[7];case 9:if(!_)return $.info("服务连接断开，准备重连中...."),this._connectState=t.EConnectionState.RECONNECTING,this.reconnectServer("BOARD_SERVER_ERROR"),[2,Promise.reject(new it(L,"connect bNode failed"))];S=!1,n.label=10;case 10:n.trys.push([10,15,16,17]),m=s(l),T=m.next(),n.label=11;case 11:return T.done?[3,14]:(A=T.value,b=A.addr,I=A.port,C=A.wss,[4,ut(this._connectRTMServer(C,b,I,u,c))]);case 12:if(D=a.apply(void 0,[n.sent(),2]),!D[0])return S=!0,[3,14];n.label=13;case 13:return T=m.next(),[3,11];case 14:return[3,17];case 15:return w=n.sent(),x={error:w},[3,17];case 16:try{T&&!T.done&&(N=m.return)&&N.call(m)}finally{if(x)throw x.error}return[7];case 17:return S?(this._connectState=t.EConnectionState.CONNECTED,this.emit(v.CONNECTION_STATE_CHANGE,this._connectState,""),$.info("auth gateway success. begin get channel info..."),this._boardSignal.doGetChannelInfo(),[3,19]):($.info("服务连接断开，准备重连中...."),this._connectState=t.EConnectionState.RECONNECTING,this.reconnectServer("RTM_SERVER_ERROR"),[2,Promise.reject(new it(L,"connect mNode failed"))]);case 18:return[2,Promise.reject(new it(O))];case 19:return[2]}}))}))},o.prototype.disconnectServer=function(e){var i,o;this._connectState=t.EConnectionState.DISCONNECTING,null===(i=this._boardSignal)||void 0===i||i.disconnectServer(e),null===(o=this._rtmSignal)||void 0===o||o.disconnectServer(e),this._boardSignal.handleMediaServerEvents=function(){},this._rtmSignal.handleMediaServerEvents=function(){},this._boardSignal=void 0,this._rtmSignal=void 0,this._reportItem=void 0,this._connectState=t.EConnectionState.DISCONNECTED,this.emit(v.CONNECTION_STATE_CHANGE,this._connectState,e||"")},o.prototype.reconnectServer=function(e){var i,o,r=this;this._connectState=t.EConnectionState.RECONNECTING,null===(i=this._boardSignal)||void 0===i||i.disconnectServer(e),null===(o=this._rtmSignal)||void 0===o||o.disconnectServer(e),this._boardSignal.handleMediaServerEvents=function(){},this._rtmSignal.handleMediaServerEvents=function(){},this._boardSignal=void 0,this._rtmSignal=void 0,this._reportItem=void 0,setTimeout((function(){r.emit(v.CONNECTION_STATE_CHANGE,r._connectState,e),$.debug("reconnect server... "),r.connectServer()}),6e3)},o.prototype.report=function(t){this._reportQueue.add(t),this._checkAndAutoStartQueue()},o.prototype._checkAndAutoStartQueue=function(){!this._reportBoardDataTimer&&this._reportQueue.size>0&&(this._reportBoardDataTimer=requestAnimationFrame(this._reportBoardData.bind(this)))},o.prototype._reportBoardData=function(e){return r(this,void 0,void 0,(function(){var i,o,r,s,a,h;return n(this,(function(n){switch(n.label){case 0:return this._connectState!==t.EConnectionState.CONNECTED?[3,29]:this._reportQueue.size>0?(i=this._reportQueue.front(),this._reportItem===i?[3,27]:(this._reportItem=i,o=i.type,r=i.data,s=i.rts,a=i.callback,h=[],o!==f.ADD_FILE?[3,2]:[4,ut(this._boardSignal.doAddFile(r,s))])):[3,28];case 1:return h=n.sent(),[3,26];case 2:return o!==f.ADD_SHAPE?[3,4]:[4,ut(this._boardSignal.doAddShape(r,s))];case 3:return h=n.sent(),[3,26];case 4:return o!==f.MOVE_SHAPE?[3,6]:[4,ut(this._boardSignal.doMoveShape(r,s))];case 5:return h=n.sent(),[3,26];case 6:return o!==f.DELETE_SHAPE?[3,8]:[4,ut(this._boardSignal.doDeleteShape(r,s))];case 7:return h=n.sent(),[3,26];case 8:return o!==f.ADD_BOARD?[3,10]:[4,ut(this._boardSignal.doAddBoard(r,s))];case 9:return(h=n.sent())[0]||a&&a(),[3,26];case 10:return o!==f.DELETE_BOARD?[3,12]:[4,ut(this._boardSignal.doDeleteBoard(r,s))];case 11:return(h=n.sent())[0]||a&&a(),[3,26];case 12:return o!==f.SWITCH_BOARD?[3,14]:[4,ut(this._boardSignal.doSwitchBoard(r,s))];case 13:return(h=n.sent())[0]||a&&a(),[3,26];case 14:return o!==f.SCALE_BOARD?[3,16]:[4,ut(this._boardSignal.doScaleBoard(r,s))];case 15:return(h=n.sent())[0]||a&&a(),[3,26];case 16:return o!==f.RATIO_BOARD?[3,18]:[4,ut(this._boardSignal.doSetBoardRatio(r,s))];case 17:return(h=n.sent())[0]||a&&a(),[3,26];case 18:return o!==f.CLEAR_BOARD?[3,20]:[4,ut(this._boardSignal.doClearBoard(r,s))];case 19:return(h=n.sent())[0],[3,26];case 20:return o!==f.RESET_BOARD?[3,22]:[4,ut(this._boardSignal.doResetBoard(s))];case 21:return(h=n.sent())[0]||a&&a(),[3,26];case 22:return o!==f.UPDATE_BACKGROUND?[3,24]:[4,ut(this._boardSignal.doUpdateBoardBackgroundColor(r,s))];case 23:return(h=n.sent())[0]||a&&a(),[3,26];case 24:return o!==f.UPDATE_BACKGROUND_IMAGE?[3,26]:[4,ut(this._boardSignal.doUpdateBoardBackgroundImage(r))];case 25:(h=n.sent())[0]||a&&a(),n.label=26;case 26:h[0]||this._reportQueue.dequeue(),n.label=27;case 27:return this._reportLts=e,[3,29];case 28:if(e-this._reportLts>3e3)return cancelAnimationFrame(this._reportBoardDataTimer),this._reportBoardDataTimer=void 0,this._reportItem=void 0,this._reportLts=0,[2];n.label=29;case 29:return requestAnimationFrame(this._reportBoardData.bind(this)),[2]}}))}))},o.prototype._handleBoardServerEvents=function(e,i){if("connection-state-change"===e){var o=i.curState,r=i.reason;i.revState,$.debug("board connection-state-change ",o),o===t.EConnectionState.RECONNECTING&&this._connectState!==t.EConnectionState.RECONNECTING&&(this._reportBoardDataTimer&&(this._reportQueue.clear(),this._reportItem=void 0,cancelAnimationFrame(this._reportBoardDataTimer)),this.reconnectServer(r))}else this.emit(e,i)},o.prototype._handleRTMServerEvent=function(e,i){if("connection-state-change"===e){var o=i.curState,r=i.reason;i.revState,$.debug("rtm connection-state-change ",o),o===t.EConnectionState.RECONNECTING&&this._connectState!==t.EConnectionState.RECONNECTING&&(this._reportBoardDataTimer&&(this._reportQueue.clear(),this._reportItem=void 0,cancelAnimationFrame(this._reportBoardDataTimer)),this.reconnectServer(r))}else"ForceOffline"===e?(this._reportBoardDataTimer&&(this._reportQueue.clear(),this._reportItem=void 0,cancelAnimationFrame(this._reportBoardDataTimer)),this.disconnectServer("FORCE_OFFLINE")):this.emit(e,i)},o.prototype._connectBoardServer=function(e,i,o,s){return r(this,void 0,void 0,(function(){return n(this,(function(r){return this._boardSignal.configServer(e,i,o),this._connectState===t.EConnectionState.CONNECTING||this._connectState===t.EConnectionState.RECONNECTING?[2,this._boardSignal.connectServer(this._channel,this._uId,s)]:[2]}))}))},o.prototype._connectRTMServer=function(t,e,i,o,s){return r(this,void 0,void 0,(function(){var a=this;return n(this,(function(h){switch(h.label){case 0:return this._rtmSignal.configServer(t,e,i),[4,this._rtmSignal.connectServer().then((function(){return r(a,void 0,void 0,(function(){var t;return n(this,(function(e){switch(e.label){case 0:return t={UserId:this._uId,UserSId:"",AcsToken:s,SdkVer:"",SessionId:o},[4,this._rtmSignal.doOnline(t)];case 1:return[2,e.sent()]}}))}))})).then((function(){return r(a,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,this._rtmSignal.doJoinChannel(this._channel)];case 1:return[2,t.sent()]}}))}))}))];case 1:return[2,h.sent()]}}))}))},o}(et);function At(t){var e=t.trim();if(/^#([0-9a-f]{3}|[0-9a-f]{6})$|^rgb\(\s*(\d+%?)\s*,\s*(\d+%?)\s*,\s*(\d+%?)\s*\)$|^rgba\(\s*(\d+%?)\s*,\s*(\d+%?)\s*,\s*(\d+%?)\s*,\s*(0|1|0?\.\d+)\s*\)$|^hsl\(\s*(\d+)\s*,\s*(\d+%?)\s*,\s*(\d+%?)\s*\)$|^hsla\(\s*(\d+)\s*,\s*(\d+%?)\s*,\s*(\d+%?)\s*,\s*(0|1|0?\.\d+)\s*\)$|^transparent$/i.test(e))return!0;var i=document.createElement("div");return i.style.color=e,""!==i.style.color}t.EBoardImageStatus=void 0,(gt=t.EBoardImageStatus||(t.EBoardImageStatus={}))[gt.BOARD_IMAGE_STATUS_LOADING=1]="BOARD_IMAGE_STATUS_LOADING",gt[gt.BOARD_IMAGE_STATUS_LOAD_DONE=2]="BOARD_IMAGE_STATUS_LOAD_DONE",gt[gt.BOARD_IMAGE_STATUS_LOAD_ABORT=3]="BOARD_IMAGE_STATUS_LOAD_ABORT",gt[gt.BOARD_IMAGE_STATUS_LOAD_ERROR=4]="BOARD_IMAGE_STATUS_LOAD_ERROR",gt[gt.BOARD_IMAGE_STATUS_LOAD_TIMEOUT=5]="BOARD_IMAGE_STATUS_LOAD_TIMEOUT",gt[gt.BOARD_IMAGE_STATUS_LOAD_CANCEL=6]="BOARD_IMAGE_STATUS_LOAD_CANCEL";var bt={id:"",channel:"",appId:"",userId:"",token:"",baseParams:{ratio:"16:9",scale:100,toolType:t.EBoardToolType.FREE_DRAW,progressBarUrl:p.LOADING_ICON,imageResourceTimeout:p.BOARD_IMAGE_RESOURCE_TIMEOUT},styleParams:{textStyle:t.EBoardTextStyle.NORMAL,textSize:16,textColor:"#333333",brushColor:"#333333",brushThin:5,globalBackgroundColor:p.BOARD_BACKGROUND_COLOR,selectBoxColor:p.BOARD_SELECT_STYLE.strokeStyle},authParams:{drawEnable:!0,progressEnable:!1}},It=function(e){function s(t){var i=e.call(this)||this;i.uid="",i._appid="",i._channel="",i._token="",i._fileId="#DEFAULT",i._fileList=new Map,i._boardId="",i._fileBoardData=new Map,i._curMaxBoardPage=1,i._renderFrameRate=5,i._initConfig=bt,i._fusionServer=void 0;var r=t.id,n=t.channel,s=t.appId,a=t.userId,h=t.token,l=t.baseParams,d=t.styleParams,p=t.serverParams,u=t.authParams;if("string"!=typeof r||0===r.length)throw new it(c.INVALID_PARAMS,"id must be string.");if(!("string"==typeof s&&s.length>0))throw new it(c.INVALID_PARAMS,"appId is invalid.");if(i._appid=s,!("string"==typeof n&&n.length>0))throw new it(c.INVALID_PARAMS,"channel must be string.");if(i._channel=n,!("string"==typeof a&&a.length>0))throw new it(c.INVALID_PARAMS,"userId must be string.");if(i.uid=a,h){if("string"!=typeof h)throw new it(c.INVALID_PARAMS,"token must be string.");i._token=h||""}var _=o(o({},bt.baseParams),l),f=o(o({},bt.styleParams),d),v=o(o({},bt.authParams),u);return p&&"{}"!==JSON.stringify(p)&&i._setParameters(p),i._initConfig=o(o({},t),{baseParams:_,styleParams:f,authParams:v}),i._initPainter(r,i._initConfig),i._joinChannel(),i}return i(s,e),Object.defineProperty(s.prototype,"_currentBoardPage",{get:function(){var t=this._fileList.get(this._fileId);return t?t.currentPageIndex:1},set:function(t){var e=this._fileList.get(this._fileId);e&&(e.currentPageIndex=t)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"_totalBoardCount",{get:function(){var t=this._fileList.get(this._fileId);return t?t.totalPageCount:1},set:function(t){var e=this._fileList.get(this._fileId);e&&(e.totalPageCount=t)},enumerable:!1,configurable:!0}),s.prototype[v.ADD_BOARD]=function(t,e){},s.prototype[v.DELETE_BOARD]=function(t,e){},s.prototype[v.GOTO_BOARD]=function(t,e){},s.prototype[v.SCALE_BOARD]=function(t,e){},s.prototype[v.RATIO_BOARD]=function(t,e){},s.prototype[v.CAN_UNDO_STATUS_CHANGE]=function(t){},s.prototype[v.CAN_REDO_STATUS_CHANGE]=function(t){},s.prototype[v.CONNECTION_STATE_CHANGE]=function(t,e){},s.prototype[v.BOARD_BACKGROUND_COLOR_CHANGE]=function(t,e,i){},s.prototype[v.IMAGE_STATUS_CHANGED]=function(t,e,i,o){},s.prototype[v.CLEAR_BOARD]=function(t,e,i){},s.prototype[v.RESET_BOARD]=function(){},s.prototype[v.ERROR]=function(t,e){},s.prototype[v.WARNING]=function(t,e){},s.prototype.getVersion=function(){return p.SDK_VERSION},s.prototype.destroy=function(){this._leaveChannel()},s.prototype._setParameters=function(t){var e=t.ConfPriCloudAddr,i=t.ConfPriCloudAddr1;if($.debug("set parameters config as "+JSON.stringify(t)),e){var o=e.ServerAdd,r=e.Port,n=!0;"boolean"==typeof(s=e.Wss)&&(n=s),p.GATEWAY_ADDRESS_SSL!==n&&(p.GATEWAY_ADDRESS_SSL=n),p.GATEWAY_ADDRESS1&&(p.GATEWAY_ADDRESS1=""),o&&(p.GATEWAY_ADDRESS=(n?"https://"+o:"http://"+o)+(r?":"+r:""))}if(i){var s;o=i.ServerAdd,r=i.Port,n=!0;"boolean"==typeof(s=i.Wss)&&(n=s),p.GATEWAY_ADDRESS_SSL!==n&&(p.GATEWAY_ADDRESS_SSL=n),o&&(p.GATEWAY_ADDRESS1=(n?"https://"+o:"http://"+o)+(r?":"+r:""))}},s.prototype.setBoardStyleParams=function(t){var e=this._initConfig;e.baseParams;var i=e.styleParams;if(Object.assign(i,t),i&&"{}"===JSON.stringify(i)){var o=i.textSize,r=i.textColor,n=i.brushColor,s=i.brushThin,a=i.selectBoxColor,h=i.globalBackgroundColor;o&&"number"!=typeof o&&(i.textSize=16),"string"!=typeof r&&(i.textColor="#333333"),"string"!=typeof n&&(i.brushColor="#333333"),s&&"number"!=typeof s&&s<5&&(i.brushThin=5),"string"!=typeof a&&(i.selectBoxColor="#eeeeee"),"string"!=typeof h&&(i.globalBackgroundColor="#ffffff")}},s.prototype.setBackgroundColor=function(e){var i;if(!At(e))throw new it(c.INVALID_PARAMS,"The background color is invalid.");if(this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED){var o={bId:this._boardId,color:e};null===(i=this._fusionServer)||void 0===i||i.report({type:f.UPDATE_BACKGROUND,data:o,rts:""+Date.now(),callback:function(){}}),this._setBoardBGColor(this._boardId,o.color)}},s.prototype.getBackgroundColor=function(){var t=this._fileBoardData.get(this._boardId);return null==t?void 0:t.color},s.prototype.setGlobalBackgroundColor=function(e){var i;if(!At(e))throw new it(c.INVALID_PARAMS,"The background color is invalid.");this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(i=this._fusionServer)||void 0===i||i.report({type:f.UPDATE_BACKGROUND,data:{bId:this._boardId,color:e},rts:""+Date.now()}),this._setGlobalBoardBGColor(e))},s.prototype.getGlobalBackgroundColor=function(){return this._initConfig.styleParams.globalBackgroundColor||""},s.prototype.setBackgroundImage=function(e,i){var o;return void 0===i&&(i="contain"),r(this,void 0,void 0,(function(){return n(this,(function(r){switch(r.label){case 0:if(!["contain","cover","fill"].includes(i))throw new it(c.INVALID_PARAMS,'The image fill mode must be one of "fill", "contain", or "cover".');return[4,this._setBoardBGImage(this._boardId,e,i)];case 1:return r.sent(),this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(o=this._fusionServer)||void 0===o||o.report({type:f.UPDATE_BACKGROUND_IMAGE,data:{bId:this._boardId,image:e,imageFillMode:i},rts:""+Date.now()})),[2]}}))}))},s.prototype.getBackgroundImage=function(){var t=this._fileBoardData.get(this._boardId);return null==t?void 0:t.image},s.prototype.getBackgroundImageFillMode=function(){var t=this._fileBoardData.get(this._boardId);return(null==t?void 0:t.imageFillMode)||"contain"},s.prototype.getCurrentFileId=function(){return this._fileId},s.prototype.getCurrentBoardId=function(){return this._boardId},s.prototype.getUndoStatus=function(){},s.prototype.getFileInfo=function(t){return this._fileList.get(t)},s.prototype.addBoard=function(){var e;if("#DEFAULT"!==this._fileId){var i=new it(c.INVALID_OPERATION,"This file not allow to add a new board.");throw $.error(i),i}var o="web_"+this.uid+"_"+Date.now()+"_"+(this._curMaxBoardPage+1)+"_"+this._fileId;if($.info("local add board: "+o),this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED){var r={bId:o,color:this._initConfig.styleParams.globalBackgroundColor,image:"",url:"",scale:100};null===(e=this._fusionServer)||void 0===e||e.report({type:f.ADD_BOARD,data:r,rts:""+Date.now(),callback:function(){}}),this._addBoard(r.bId)}},s.prototype.deleteBoard=function(e){var i;if("#DEFAULT"!==this._fileId){var o=new it(c.INVALID_OPERATION,"The file does not allow deleting the whiteboard.");throw $.error(o),o}if(1===this._currentBoardPage){o=new it(c.INVALID_OPERATION,"The default whiteboard page cannot be deleted.");throw $.error(o),o}if(e&&"string"!=typeof e){o=new it(c.INVALID_PARAMS,"The boardId parameter must be string.");throw $.error(o),o}var r=e||this._boardId;$.info("local delete board: "+r);var n=this._fileBoardData.get(r);if(n){var s=n.bId;this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(i=this._fusionServer)||void 0===i||i.report({type:f.DELETE_BOARD,data:{bIds:[s]},rts:""+Date.now(),callback:function(){}}),this._deleteBoard([s]))}else $.error("Error: Can not find the board id is "+e+".")},s.prototype.setBoardRatio=function(e){var i;if("string"!=typeof e){var o=new it(c.INVALID_PARAMS,"The ratio parameter must be string.");throw $.error(o),o}var r=e.replace(/\s/g,"");this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(i=this._fusionServer)||void 0===i||i.report({type:f.RATIO_BOARD,data:{bId:this._boardId,ratio:e},rts:""+Date.now(),callback:function(){}}),this._ratioBoard(this._boardId,r))},s.prototype.getBoardRatio=function(){var t=this._fileBoardData.get(this._boardId);return(null==t?void 0:t.ratio)||""},s.prototype.getBoardList=function(){var t=[];return this._fileList.forEach((function(e){t.push.apply(t,h([],a(e.boardList)))})),t},s.prototype.getFileBoardList=function(t){var e=this._fileList.get(t);return e?e.boardList:[]},s.prototype.setBoardScale=function(e){var i;if("number"!=typeof e){var o=new it(c.INVALID_PARAMS,"The scale parameter must be number.");throw $.error(o),o}e>=100&&this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(i=this._fusionServer)||void 0===i||i.report({type:f.SCALE_BOARD,data:{bId:this._boardId,scale:e},rts:""+Date.now(),callback:function(){}}),this._scaleBoard(this._boardId,e))},s.prototype.getBoardScale=function(){var t=this._fileBoardData.get(this._boardId);return(null==t?void 0:t.scale)||100},s.prototype.prevBoard=function(){var e;if(1!==this._currentBoardPage&&this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED){var i=this._currentBoardPage-1,o=this._fileList.get(this._fileId).boardList[i-1];null===(e=this._fusionServer)||void 0===e||e.report({type:f.SWITCH_BOARD,data:{bId:o},rts:""+Date.now(),callback:function(){}}),this._gotoBoard(o),$.info("switch to page "+this._currentBoardPage)}},s.prototype.nextBoard=function(){var e;if(!(this._currentBoardPage>=this._totalBoardCount)&&this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED){var i=this._currentBoardPage+1,o=this._fileList.get(this._fileId).boardList[i-1];null===(e=this._fusionServer)||void 0===e||e.report({type:f.SWITCH_BOARD,data:{bId:o},rts:""+Date.now(),callback:function(){}}),this._gotoBoard(o),$.info("switch to page "+this._currentBoardPage)}},s.prototype.gotoBoard=function(e){var i;if(this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED)null===(i=this._fusionServer)||void 0===i||i.report({type:f.SWITCH_BOARD,data:{bId:e},rts:""+Date.now(),callback:function(){}}),this._gotoBoard(e),$.info("switch to page "+this._currentBoardPage);else{var o=new it(c.INVALID_OPERATION,"Make sure you are connected to the whiteboard service.");$.warning(o)}},s.prototype.reset=function(){var e;if(this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED)null===(e=this._fusionServer)||void 0===e||e.report({type:f.RESET_BOARD,data:void 0,rts:""+Date.now(),callback:function(){}}),this._resetBoard();else{var i=new it(c.INVALID_OPERATION,"Make sure you are connected to the whiteboard service.");$.warning(i)}},s.prototype.getBoardSnapshot=function(){var t;return null===(t=this._painter)||void 0===t?void 0:t.getSnapShortImage()},s.prototype.setEnable=function(t){if("boolean"!=typeof t){var e=new it(c.INVALID_PARAMS,"The enable parameter must be boolean.");throw $.warning(e),e}this._painter.setEnable(t)},s.prototype.getEnable=function(){return this._painter.getEnable()},s.prototype.setBrushColor=function(t){var e;null===(e=this._painter)||void 0===e||e.setBrushColor(t)},s.prototype.getBrushColor=function(){return this._painter.brushColor},s.prototype.setBrushType=function(t){var e;null===(e=this._painter)||void 0===e||e.setBrushType(t)},s.prototype.getBrushType=function(){var t;return null===(t=this._painter)||void 0===t?void 0:t.brushType},s.prototype.setBrushThin=function(t){var e;null===(e=this._painter)||void 0===e||e.setBrushThin(t)},s.prototype.getBrushThin=function(){return this._painter.brushThin},s.prototype.setTextColor=function(t){var e;if(!At(t))throw new it(c.INVALID_PARAMS,"The text color is invalid.");null===(e=this._painter)||void 0===e||e.setTextColor(t)},s.prototype.getTextColor=function(){var t;return null===(t=this._painter)||void 0===t?void 0:t.getTextColor()},s.prototype.setTextSize=function(t){var e;if("number"!=typeof t)throw new it(c.INVALID_PARAMS,"The size must be number.");null===(e=this._painter)||void 0===e||e.setTextSize(t)},s.prototype.getTextSize=function(){var t;return null===(t=this._painter)||void 0===t?void 0:t.getTextSize()},s.prototype.resize=function(){var t,e=this;null===(t=this._painter)||void 0===t||t.renderSize();var i=this._fileBoardData.get(this._boardId);i&&(this._painter.clear(!0),i.pList.forEach((function(t){e._convertBrushDataAndRenderToBoard(t)})),this._painter.renderControlBox())},s.prototype._clearBackground=function(){var t,e=this._fileBoardData.get(this._boardId);this._painter.clearBackground(),e.color=null===(t=this._initConfig.styleParams)||void 0===t?void 0:t.globalBackgroundColor,e.image="",e.imageFillMode="contain",e.url=""},s.prototype.clear=function(e){var i,o=this._fileBoardData.get(this._boardId);if(e&&this._clearBackground(),this._painter.clearAll(),o.pList.clear(),this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED)null===(i=this._fusionServer)||void 0===i||i.report({type:f.CLEAR_BOARD,data:{bId:this._boardId,bg:!!e},rts:""+Date.now()});else{var r=new it(c.INVALID_OPERATION,"Make sure you are connected to the whiteboard service.");$.warning(r)}},s.prototype.undo=function(){var t;this._painter.canUndoList.length>0&&(null===(t=this._painter)||void 0===t||t.undo())},s.prototype.redo=function(){var t;this._painter.canRedoList.length>0&&(null===(t=this._painter)||void 0===t||t.redo())},s.prototype._joinChannel=function(){return r(this,void 0,void 0,(function(){var e,i,o,r=this;return n(this,(function(n){switch(n.label){case 0:return(e=new Tt(this._appid,this.uid,this._channel,this._token)).on("connection-state-change",(function(e,i){r.emit(v.CONNECTION_STATE_CHANGE,e,i),t.EConnectionState.CONNECTED})),e.on("RecvMsgFromPeer",this._handleP2PMsg.bind(this)),e.on("RecvMsgFromChan",this._handleChannelMsg.bind(this)),this._fusionServer=e,[4,ut(e.connectServer())];case 1:if(i=a.apply(void 0,[n.sent(),1]),o=i[0]){switch(o.code){case T:this.emit(v.ERROR,t.EBoardErrorCode.INIT_ERROR,T);break;case A:case b:case I:case C:case D:case w:case R:case B:this.emit(v.ERROR,t.EBoardErrorCode.AUTH_FAILED,o.code)}return[2]}return[2]}}))}))},s.prototype._leaveChannel=function(){var e;this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(e=this._fusionServer)||void 0===e||e.disconnectServer(),this._fusionServer=void 0,this.emit(v.CONNECTION_STATE_CHANGE,t.EConnectionState.DISCONNECTED,"")),this._fileList.clear(),this._fileId="",this._initConfig=bt,this._fileBoardData.clear(),this._channel="",this._token="",this._appid="",this.uid="",this._boardId="",this._curMaxBoardPage=1,this._painter.setEnable(!1),this._painter.clearAll(),this._painter.destroy(),this.removeAllListeners()},s.prototype.on=function(t,i){e.prototype.on.call(this,t,i)},s.prototype._initPainter=function(t,e){var i,s=this;if(!this._painter){if(!t)throw new it(c.INVALID_PARAMS);var a=e.baseParams,h=e.styleParams,l=o(o({ratio:"16:9",scale:100},a),h);this._painter=new at(t,l),(null===(i=this._initConfig.authParams)||void 0===i?void 0:i.progressEnable)&&this._painter.showLoading(),this._painter.setEnable(!1),this._painter.setBrushType(l.toolType),setInterval((function(){var t,e,i=s._painter.getNeedUpdateShapeData();if(i)if(i.action===f.ADD_SHAPE){var r=i.data;s._saveToBoardBrushData(i.bId,r),null===(t=s._fusionServer)||void 0===t||t.report({type:i.action,data:o(o({},r),{bId:i.bId}),rts:""+Date.now()})}else if(i.action===f.MOVE_SHAPE){var n=i.data,a=n.pIds,h=n.offset;null===(e=s._fusionServer)||void 0===e||e.report({type:i.action,data:o(o({},i.data),{bId:i.bId}),rts:""+Date.now()});var c=s._fileBoardData.get(i.bId);c&&c.pList.forEach((function(t){if(a.includes(t.pId)){var e=[t.width*h[0],t.height*h[1]];t.position=e}}))}}),1e3/this._renderFrameRate),this._painter.on("reportContent",(function(t){return r(s,void 0,void 0,(function(){var e,i,r,s,a,h,c,l,d,p,u,_,E;return n(this,(function(n){return t&&(t.action===f.ADD_SHAPE?(e=t.data,null===(d=this._fusionServer)||void 0===d||d.report({type:t.action,data:o(o({},e),{bId:t.bId}),rts:""+Date.now()}),this._saveToBoardBrushData(t.bId,e)):t.action===f.DELETE_SHAPE?(null===(p=this._fusionServer)||void 0===p||p.report({type:t.action,data:o(o({},t.data),{bId:t.bId}),rts:""+Date.now()}),i=t.data.pIds,(r=this._fileBoardData.get(t.bId))&&r.pList.forEach((function(t){var e=t.pId;~i.indexOf(e)&&r.pList.delete(e)}))):t.action===f.MOVE_SHAPE&&(s=t.data,a=s.pIds,h=s.offset,null===(u=this._fusionServer)||void 0===u||u.report({type:t.action,data:o(o({},t.data),{bId:t.bId}),rts:""+Date.now()}),(c=this._fileBoardData.get(t.bId))&&c.pList.forEach((function(t){if(a.includes(t.pId)){var e=[t.width*h[0],t.height*h[1]];t.position=[t.position[0]+e[0],t.position[1]+e[1]]}})))),t&&((l=this._fileBoardData.get(t.bId)).canUndoList=this._painter.canUndoList,l.canRedoList=this._painter.canRedoList,this.emit(v.CAN_REDO_STATUS_CHANGE,(null===(_=this._painter)||void 0===_?void 0:_.canRedoList.length)>0),this.emit(v.CAN_UNDO_STATUS_CHANGE,(null===(E=this._painter)||void 0===E?void 0:E.canUndoList.length)>0)),[2]}))}))}))}},s.prototype._processChannelInfo=function(t){var e,i=this,o=t.fId,r=t.fileList;if(0===r.length){var n=Date.now();this._fileId="#DEFAULT",this._currentBoardPage=1,this._totalBoardCount=1,this._boardId="web_"+this.uid+"_"+n+"_"+this._currentBoardPage+"_"+this._fileId;var s=new ht;s.boardList=[this._boardId],null===(e=this._fusionServer)||void 0===e||e.report({type:f.ADD_FILE,data:s,rts:""+Date.now()}),this._fileList.set(this._fileId,s),this._boardId="web_"+this.uid+"_"+n+"_1_"+this._fileId;var a=new ct(this._boardId);a.scale=this._initConfig.baseParams.scale,a.ratio=this._initConfig.baseParams.ratio,this._fileBoardData.set(this._boardId,a)}else{this._fileId=o,r.forEach((function(t){var e=t.boardList;t.boardList=[],e.forEach((function(e){var o,r;t.boardList.push(e.bId),e.pList=new Map;var n=new ct(e.bId);n.scale=e.scale,n.ratio=e.ratio||(null===(r=null===(o=i._initConfig)||void 0===o?void 0:o.baseParams)||void 0===r?void 0:r.ratio),n.color=e.color,n.image=e.image,n.imageFillMode=e.imageFillMode,n.url=e.url,i._fileBoardData.set(e.bId,n)})),i._fileList.set(i._fileId,t)}));var h=this._fileList.get(this._fileId),c=h.currentPageIndex,l=h.totalPageCount,d=h.boardList;this._currentBoardPage=c,this._totalBoardCount=l,this._boardId=d[c-1];var p=d[d.length-1].split("_");this._curMaxBoardPage=Number(p[p.length-2])}},s.prototype._processBoardData=function(t){var e=this;t.data.forEach((function(t){$.debug("convert to board ("+t.bId+") data.");var i=e._fileBoardData.get(t.bId);i&&(i.scale=t.scale,i.ratio=t.ratio||e._initConfig.baseParams.ratio,i.url=t.url,i.image=t.image,i.color=t.color,t.pList.forEach((function(t){e._saveToBoardBrushData(i.bId,t)})))}))},s.prototype._calculateScaleProps=function(t,e,i,o){var r=this._painter.width/i;if(t===_.FREE_DRAW||t===_.ARROW){var n=e.points.map((function(t){return[t[0]*r,t[1]*r]}));e.points=n}else t===_.CIRCLE||t===_.LASER_POINTER?(e.cx=e.cx*r,e.cy=e.cy*r):t===_.ELLIPSE?(e.cx*=r,e.cy*=r,e.xr*=r,e.yr*=r):t===_.LINE?(e.x*=r,e.y*=r,e.x1*=r,e.y1*=r):t===_.RECT?(e.x1*=r,e.y1*=r,e.x2*=r,e.y2*=r):t===_.TEXT&&(e.x*=r,e.y*=r,e.fontSize*=r,e.lineHeight*=r)},s.prototype._convertBrushDataToCurrentBoardSize=function(t){var e=JSON.parse(JSON.stringify(t)),i=e.width,o=e.height,r=e.shape,n=e.props,s=this._painter.width/i,a=this._painter.width/i,h=this._painter.height/o;if(r===_.FREE_DRAW||r===_.ARROW){var c=n.points.map((function(t){return[t[0]*a,t[1]*h]}));n.points=c}else r===_.LASER_POINTER?(n.cx=n.cx*a,n.cy=n.cy*h):r===_.ELLIPSE?(n.cx*=a,n.cy*=h,n.xr*=a,n.yr*=h):r===_.LINE?(n.x*=a,n.y*=h,n.x1*=a,n.y1*=h):r===_.RECT?(n.x1*=a,n.y1*=h,n.x2*=a,n.y2*=h):r===_.TEXT&&(n.x*=a,n.y*=h,n.fontSize*=s,n.lineHeight*=s,n.maxWidth*=a,n.maxHeight*=h);return e.width=this._painter.width,e.height=this._painter.height,e.position=[e.position[0]*a,e.position[1]*h],e},s.prototype._saveToBoardBrushData=function(t,e){var i=e.shape,o=e.pId,r=e.props;e.position,e.width,e.height;var n=this._fileBoardData.get(t);if(n){var s=n.pList.get(o);if(s)if(i===_.FREE_DRAW){var a=s.props.points,h=r.points;a.map((function(t){return t.toString()})).every((function(t){return h.toString().includes(t)}))||(s.props.points=a.concat(h))}else s.props=r;else n.pList.set(o,e)}},s.prototype._convertBrushDataAndRenderToBoard=function(t){var e=this._painter.width/t.width,i=this._convertBrushDataToCurrentBoardSize(t),r=i.shape,n=i.props,s=i.position,a=i.pId,h=i.style;i.width,i.height;var c=new nt[r](a,{props:n,position:s,style:o(o({},h),{lineWidth:h.lineWidth*e})});this._painter.addElement(c)},s.prototype._renderCurrentPainter=function(){var t=this,e=this._fileBoardData.get(this._boardId);if(e){this._boardId=e.bId,this._painter.id=this._boardId;var i=e.ratio||this._initConfig.baseParams.ratio;this._painter.setBoardRatio(i),this._painter.setCanvasBGColor(e.color),this._painter.setCanvasBGImage(e.image,e.imageFillMode),this._painter.scalePainter(e.scale),this._painter.reset(),this._painter.canUndoList=e.canUndoList,this._painter.canRedoList=e.canRedoList,e.pList.forEach((function(e){t._convertBrushDataAndRenderToBoard(e)}))}},s.prototype._convertBrushDataToCurrentPainter=function(){},s.prototype._handleP2PMsg=function(t){var e,i;t.ChanId,t.FromUId;var o=t.MsgBody;t.MsgId,t.MsgType;var r=JSON.parse(o),n=r.cmd,s=r.data;if(n===f.CHAN_DATA)this._processChannelInfo(s),this._painter.id=this._boardId,this._painter.uid=this.uid;else if(n===f.CUR_BOARD_DATA){$.info("get current board data.");var a=r.isFinished;this._processBoardData(r),this._renderCurrentPainter(),a&&((null===(e=this._initConfig.authParams)||void 0===e?void 0:e.progressEnable)&&this._painter.hideLoading(),(null===(i=this._initConfig.authParams)||void 0===i?void 0:i.drawEnable)&&this._painter.setEnable(!0),this.emit(v.DATA_SYNC_COMPLETED))}else n===f.CACHE_BOARD_DATA&&($.info("get cache board data."),this._processBoardData(r))},s.prototype._handleChannelMsg=function(t){var e,i,o=this;t.ChanId;var r=t.FromUId,n=t.MsgBody;t.MsgId,t.MsgType;var s=JSON.parse(n),a=s.cmd;s.bId;var h=s.data;if(r!==this.uid)if(a===f.ADD_SHAPE){var c=h.bId,l=h.pId,d=h.shape,p=h.props;if(h.style,h.width,h.height,h.offset,$.debug("remote user add shape ("+d+" - "+l+")"),A=this._fileBoardData.get(c)){var u=A.pList.get(l);if(u)if(d===_.FREE_DRAW){var E=u.props.points,g=p.points;E.map((function(t){return t.toString()})).every((function(t){return g.toString().includes(t)}))||(u.props.points=E.concat(g))}else u.props=p;else A.pList.set(l,h);c===this._boardId&&(this._painter.clear(),A.pList.forEach((function(t){o._convertBrushDataAndRenderToBoard(t)})))}}else if(a===f.DELETE_SHAPE){var y=h.bId,S=h.pIds;$.debug("remote user delete shapes: "+S);var m=this._fileBoardData.get(y);if(m){var T=y===this._boardId;T&&(this._painter.clearSelfLaserPoint(),this._painter.clear()),m.pList.forEach((function(t){var e=t.pId;~S.indexOf(e)?m.pList.delete(e):T&&o._convertBrushDataAndRenderToBoard(t)}))}}else if(a===f.MOVE_SHAPE){var A,b=h.bId,I=h.pIds,C=h.offset;$.debug("remote user move shapes: "+I+", offset: "+C),(A=this._fileBoardData.get(b))&&(this._painter.clearSelfLaserPoint(),this._painter.clear(),A.pList.forEach((function(t){if(~I.indexOf(t.pId)){var e=t.width,i=t.height,r=[C[0]*e,C[1]*i];t.shape===_.LASER_POINTER?t.position=r:(t.position[0]+=r[0],t.position[1]+=r[1])}b===o._boardId&&o._convertBrushDataAndRenderToBoard(t)})))}else if(a===f.FILE_LIST){h.fId,h.fileList.forEach((function(t){var e=new ht;e.type=t.type,e.fId=t.fId,e.url=t.url,e.title=t.title,e.currentPageIndex=t.currentPageIndex,e.totalPageCount=t.totalPageCount,e.width=t.width,e.height=t.height,t.boardList.forEach((function(t){e.boardList.push(t.bId);var i=new ct(t.bId);i.scale=t.scale,i.ratio=t.ratio,i.color=t.color,i.image=t.image,i.url=t.url,o._fileBoardData.set(t.bId,i)})),o._fileList.set(t.fId,e)}))}else if(a===f.ADD_BOARD){var D=h.bId;$.debug("remote user add board: "+D),this._painter.releaseMouse(),this._addBoard(D)}else if(a===f.DELETE_BOARD){var w=h.bIds;$.debug("remote user delete board: "+w),this._painter.releaseMouse(),this._deleteBoard(w)}else if(a===f.SWITCH_BOARD){var B=h.bId;$.debug("remote user switch to board: "+B),this._painter.releaseMouse(),this._gotoBoard(B)}else if(a===f.SCALE_BOARD){var R=h,O=R.bId,L=R.scale;$.debug("remote user scale board to "+L),this._painter.releaseMouse(),this._scaleBoard(O,L),this.emit(v.SCALE_BOARD,O,L)}else if(a===f.RATIO_BOARD){var x=h,N=x.bId,P=x.ratio;$.debug("remote user ratio board to "+P),this._painter.releaseMouse(),this._ratioBoard(N,P),this.emit(v.RATIO_BOARD,N,P)}else if(a===f.CLEAR_BOARD){this._painter.releaseMouse();var M=h,k=M.bId,W=M.bg;$.debug("remote user clear board brush true, clear background "+W);var U=this._fileBoardData.get(k);U&&(U.pList.clear(),U.canUndoList=[],U.canRedoList=[],this._painter.clearAll(),W&&this._clearBackground(),this.emit(v.CLEAR_BOARD,this._fileId,this._boardId,!!W),this.emit(v.CAN_REDO_STATUS_CHANGE,(null===(e=this._painter)||void 0===e?void 0:e.canRedoList.length)>0),this.emit(v.CAN_UNDO_STATUS_CHANGE,(null===(i=this._painter)||void 0===i?void 0:i.canUndoList.length)>0))}else if(a===f.RESET_BOARD)$.debug("remote user rest board"),this._painter.releaseMouse(),this._resetBoard(),this.emit(v.RESET_BOARD);else if(a===f.UPDATE_BACKGROUND){var G=h.bId,H=h.color;$.debug("remote user update background color "+H),this._setBoardBGColor(G,H),this.emit(v.BOARD_BACKGROUND_COLOR_CHANGE,this._fileId,G,H)}else if(a===f.UPDATE_BACKGROUND_IMAGE){var F=h.bId,V=h.image,K=h.imageFillMode;$.debug("remote user update background image "+V),this._setBoardBGImage(F,V,K)}else f.UPDATE_BACKGROUND_H5},s.prototype._getFileInfo=function(t){var e=this._fileList.get(t);return e||null},s.prototype._addBoard=function(t){var e,i;this._curMaxBoardPage+=1;var o=new ct(t);o.color=this._initConfig.styleParams.globalBackgroundColor,o.ratio=this._initConfig.baseParams.ratio,this._fileBoardData.set(t,o);var r=this._fileList.get(this._fileId);r.boardList.push(t),this._currentBoardPage=r.boardList.length,this._totalBoardCount=r.boardList.length,this._boardId=t,$.info("切换到第"+this._currentBoardPage+"页"),this._renderCurrentPainter(),this.emit(v.ADD_BOARD,this._fileId,[t]),this.emit(v.GOTO_BOARD,this._fileId,this._boardId),this.emit(v.CAN_REDO_STATUS_CHANGE,(null===(e=this._painter)||void 0===e?void 0:e.canRedoList.length)>0),this.emit(v.CAN_UNDO_STATUS_CHANGE,(null===(i=this._painter)||void 0===i?void 0:i.canUndoList.length)>0)},s.prototype._deleteBoard=function(t){for(var e,i,o=this._getFileInfo(this._fileId),r=o.boardList.length-1;r>-1;r--){var n=o.boardList[r];t.includes(n)&&(this._fileBoardData.delete(n),o.boardList.splice(r,1),n===this._boardId&&(this._currentBoardPage-=1,this._totalBoardCount=o.boardList.length,$.info("切换到第"+this._currentBoardPage+"页"),this._boardId=o.boardList[this._currentBoardPage-1],this._renderCurrentPainter(),this.emit(v.GOTO_BOARD,this._fileId,this._boardId),this.emit(v.CAN_REDO_STATUS_CHANGE,(null===(e=this._painter)||void 0===e?void 0:e.canRedoList.length)>0),this.emit(v.CAN_UNDO_STATUS_CHANGE,(null===(i=this._painter)||void 0===i?void 0:i.canUndoList.length)>0)))}this.emit(v.DELETE_BOARD,this._fileId,[t])},s.prototype._gotoBoard=function(t){var e,i,o=this._getFileInfo(this._fileId),r=o.boardList.indexOf(t);this._currentBoardPage=r+1,this._totalBoardCount=o.boardList.length,this._boardId=t,$.info("切换到第"+this._currentBoardPage+"页, 总页数 "+this._totalBoardCount),this._renderCurrentPainter(),this.emit(v.GOTO_BOARD,this._fileId,this._boardId),this.emit(v.CAN_REDO_STATUS_CHANGE,(null===(e=this._painter)||void 0===e?void 0:e.canRedoList.length)>0),this.emit(v.CAN_UNDO_STATUS_CHANGE,(null===(i=this._painter)||void 0===i?void 0:i.canUndoList.length)>0)},s.prototype._resetBoard=function(){$.info("board reset success."),this._painter.clearAll();var t=this._getFileInfo(this._fileId);this._fileList.clear();var e=t.boardList[0],i=new ct(e),o=this._fileBoardData.get(e);i.ratio=o.ratio,this._boardId=e,this._fileId="#DEFAULT",t.fId=this._fileId,t.boardList=[e],this._fileBoardData.clear(),this._fileBoardData.set(e,i),this._fileList.set(this._fileId,t),this._currentBoardPage=1,this._totalBoardCount=1,this._curMaxBoardPage=1,this._boardId=e,this._renderCurrentPainter()},s.prototype._scaleBoard=function(t,e){var i=this,o=this._fileBoardData.get(t);o&&(o.scale=e),t===this._boardId&&($.info("白板缩放至"+e),this._painter.scalePainter(e),this._painter.clear(!0),this._painter.canUndoList=o.canUndoList,this._painter.canRedoList=o.canRedoList,o&&o.pList.forEach((function(t){i._convertBrushDataAndRenderToBoard(t)})),this._painter.renderControlBox())},s.prototype._ratioBoard=function(t,e){var i=this,o=this._fileBoardData.get(t);o&&(o.ratio=e),t===this._boardId&&($.info("白板比例变更为"+e),this._painter.setBoardRatio(e),this._painter.clear(!0),o&&o.pList.forEach((function(t){i._convertBrushDataAndRenderToBoard(t)})),this._painter.renderControlBox())},s.prototype._setBoardBGColor=function(t,e){var i,o=this._fileBoardData.get(t);o&&(o.color=e),t===this._boardId&&(null===(i=this._painter)||void 0===i||i.setCanvasBGColor(e),$.info("白板背景颜色改变为："+e))},s.prototype._setGlobalBoardBGColor=function(t){var e=this,i=this._getFileInfo(this._fileId);i&&(this._initConfig.styleParams.globalBackgroundColor=t,i.boardList.forEach((function(i){var o,r=e._fileBoardData.get(i);r.color=t,r.bId===e._boardId&&(null===(o=e._painter)||void 0===o||o.setCanvasBGColor(t))})))},s.prototype._setBoardBGImage=function(e,i,o){var r=this;return void 0===o&&(o="contain"),new Promise((function(n,s){var a,h,l,p;if(/^https:\/\//i.test(i)){var u=new Image,_=(a=function(){u.src="",u.onload=function(){},u.onabort=function(){},u.onerror=function(){};var n=new it(d.INVALID_IMAGE_ASSETS,"The image resource request timeout.");$.error(n),r.emit(v.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOAD_TIMEOUT,{imageUrl:i,imageFillMode:o})},h=r._initConfig.baseParams.imageResourceTimeout,l=null,p=function(){l&&(clearTimeout(l),l=null)},l=setTimeout((function(){p(),a&&a()}),h||1e3),p);u.onload=function(s){_();var a=r._fileBoardData.get(e);a&&(a.image=i,a.imageFillMode=o),e===r._boardId&&(r._painter.setCanvasBGImage(i,o),$.info("白板背景颜色图片改变为："+i)),r.emit(v.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOAD_DONE,{imageUrl:i,imageFillMode:o}),n()},u.onabort=function(n){_();var s=new it(d.INVALID_IMAGE_ASSETS,"The image resource request aborted.");$.error(s),r.emit(v.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOAD_ABORT,{imageUrl:i,imageFillMode:o})},u.onerror=function(n){_();var s=new it(d.INVALID_IMAGE_ASSETS,"The image resource request error.");$.error(s),r.emit(v.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOAD_ERROR,{imageUrl:i,imageFillMode:o})},u.src=i,r.emit(v.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOADING,{imageUrl:i,imageFillMode:o})}else s(new it(c.INVALID_PARAMS,"imageUrl must be https or http files."))}))},s.prototype._setBoardH5=function(t,e){var i=this._fileBoardData.get(t);i&&(i.url=e),t===this._boardId&&(this._painter.setCanvasBGH5(e),$.info("白板背景颜色图片改变为："+e))},s}(et);t.ArWhiteBoard=It,t.default=It,Object.defineProperty(t,"__esModule",{value:!0})}));
